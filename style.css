  :root{
    --bg:#0b0f14; --panel:#121821; --panel-2:#0f151e; --ink:#e9eef7; --muted:#a7b0c0;
    --brand:#7aa2ff; --accent:#86f0d1; --danger:#ff6b6b; --warn:#ffc04d; --ok:#59db7d;
    --grid:#1c2230; --grid-2:#151a25; --glow:0 0 20px rgba(122,162,255,.25);
    --pc:#2e6a53; --npc:#5a365a; --keeper:#1f2a44;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:radial-gradient(1200px 700px at 70% -10%,#182134 0,#0b0e12 55%,#070a0f 100%);
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    letter-spacing:.15px;
  }
  a{color:var(--brand)}
  button,select,input,textarea{
    background:var(--panel); color:var(--ink); border:1px solid #212a3b; border-radius:8px; padding:.6rem .75rem
  }
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg,#1f2a44,#152037);border-color:#31405c;box-shadow:var(--glow)}
  button.ghost{background:transparent;border-color:#2a3345}
  button.warn{background:linear-gradient(180deg,#3a2a10,#2a1e0a);border-color:#624314;color:#ffd98a}
  button.danger{background:linear-gradient(180deg,#3a1111,#260b0b);border-color:#652626;color:#ffc8c8}
  button.success{background:linear-gradient(180deg,#0f2a1a,#0a2014);border-color:#26543c;color:#b2ffd2}
  label{font-size:.9rem;color:var(--muted)}
  .row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
  .col{display:flex;flex-direction:column;gap:.5rem}
  .pill{display:inline-flex;align-items:center;gap:.5rem;padding:.2rem .55rem;border-radius:999px;background:#151b27;border:1px solid #2a3345;color:#b6c2d8;font-size:.8rem}
  .tag{font-size:.75rem;color:#9cadc6;background:#101521;border:1px solid #263147;border-radius:6px;padding:.2rem .4rem}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;border:1px solid #2a3345;background:#0d1220;border-radius:6px;padding:.1rem .35rem;color:#b9c7e6}

  header.appbar{
    position:sticky;top:0;z-index:50;background:rgba(10,14,20,.9);backdrop-filter:blur(6px);
    border-bottom:1px solid #1b2332;display:flex;align-items:center;gap:1rem;padding:.75rem 1rem
  }
  header.appbar h1{margin:0;font-size:1rem;letter-spacing:.12rem;text-transform:uppercase;color:#bcd1ff}
  header.appbar nav{display:flex;gap:.5rem;flex-wrap:wrap}
  header.appbar nav button{padding:.45rem .6rem}

  .container{display:grid;grid-template-columns:320px 1fr 360px;gap:1rem;padding:1rem;align-items:stretch}
  @media (max-width: 1100px){ .container{grid-template-columns:1fr} }

  .panel{background:linear-gradient(180deg, var(--panel), var(--panel-2));border:1px solid #1a2130;border-radius:12px;padding:1rem;box-shadow:var(--glow)}
  .panel h2{margin:.25rem 0 1rem 0;font-size:1rem;color:#c9d6f7}
  .leftcol,.rightcol{display:flex;flex-direction:column;gap:1rem}

  /* Map */
  #mapWrap{position:relative;border-radius:12px;overflow:hidden}
  #map{position:relative;aspect-ratio:3/2;background:
      linear-gradient(0deg, rgba(0,0,0,.25), rgba(0,0,0,.25)),
      radial-gradient(1200px 800px at 80% -10%,rgba(134,240,209,.04),transparent 60%),
      #0c1119;
    outline:1px solid #1a2130}
  #mapBg{position:absolute;inset:0;background-size:cover;background-position:center;filter:contrast(1.02) saturate(1.02) brightness(.9)}
  #grid{position:absolute;inset:0;background-image:
      linear-gradient(to right, var(--grid) 1px, transparent 1px),
      linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
    background-size:calc(100%/12) calc(100%/8);mix-blend-mode:overlay;opacity:.9;pointer-events:none}
  #fog{position:absolute;inset:0;pointer-events:none}
  #reach{position:absolute;inset:0;pointer-events:none}

  .token{
    position:absolute; width:calc(100%/12); height:calc(100%/8);
    transform:translate(-50%,-50%); display:flex; align-items:center; justify-content:center; transition:transform .25s ease;
  }
  .token .bubble{
    width:60%; aspect-ratio:1/1; border-radius:50%; border:2px solid #25324a;
    background:radial-gradient(50% 50% at 30% 30%, #415379, #1a2333);
    display:flex;align-items:center;justify-content:center;overflow:hidden; box-shadow:0 4px 16px rgba(0,0,0,.4);
  }
  .token img{width:100%;height:100%;object-fit:cover;border-radius:50%}
  .token .letters{font-weight:700;color:#d8e4ff}
  .token.pc .bubble{background:radial-gradient(50% 50% at 30% 30%, var(--pc), #15251f)}
  .token.npc .bubble{background:radial-gradient(50% 50% at 30% 30%, var(--npc), #1f1521)}
  .token.active-turn .bubble{box-shadow:0 0 12px 2px var(--accent);border-color:var(--accent)}
  .token .cap{position:absolute;bottom:-.25rem;left:50%;transform:translateX(-50%);
    font-size:.7rem;background:#0e1421;border:1px solid #223049;border-radius:6px;padding:.05rem .35rem;color:#cfe1ff}

  .measure{position:absolute;border-top:2px dashed #6ea2ff;pointer-events:none;transform-origin:0 0}
  .measure .label{position:absolute;top:-1.35rem;right:-.25rem;background:#0e1626;border:1px solid #24324c;border-radius:8px;padding:.1rem .35rem;
    color:#cfe1ff;font-size:.75rem}

  /* Chat (fixed height + scrollbar) */
  #chat{display:flex;flex-direction:column;height:100%}
  #chatLog{
    flex:1; /* fill remaining space */
    overflow-y:auto;
    min-height:0;
    background:#0c121d;border:1px solid #1a2130;border-radius:8px;padding:.75rem;scroll-behavior:smooth;
  }
  #chatLog .line{display:flex;align-items:flex-start;gap:.6rem;margin:.45rem 0}
  #chatLog .line.action{font-style:italic;color:var(--muted);background:#0c121d;border-radius:4px;padding:.2rem .4rem}
  #chatLog .line.system{color:var(--muted)}
  #chatLog .who{opacity:.85;font-weight:600}
  #chatLog .content{flex:1}
  #chatLog .controls{display:flex;gap:.25rem}
  #chatLog .keeper .who{color:#bcd1ff}
  #chatLog .you .who{color:#d5f7e7}
  .avatar{width:28px;height:28px;border-radius:50%;overflow:hidden;border:1px solid #223049;flex:none}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .speakerName{font-weight:700}
  #chatEntry{display:flex;gap:.5rem;margin-top:.5rem;flex-wrap:wrap}
  #chatEntry input{flex:1;min-width:220px}
  #chatEntry button{white-space:nowrap}

  .note{font-size:.85rem;color:#a6b4cc}

  /* Modals */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:90}
  .modal.show{display:flex}
  .modal .scrim{position:absolute;inset:0;background:rgba(6,8,12,.75);backdrop-filter:blur(6px)}
  .modal .sheet{position:relative;max-width:1100px;width:min(1100px,96vw);max-height:90vh;overflow:auto;border-radius:14px;
    background:linear-gradient(180deg,#0d1220,#0a0f19);border:1px solid #1a2231;padding:1rem;box-shadow:0 10px 40px rgba(0,0,0,.5)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.75rem}
  .thin{font-weight:500;color:#b6c1d6}
  .small{font-size:.85rem;color:#9fb0c8}
  .hr{height:1px;background:#1b2333;margin:.75rem 0}
  .right{justify-content:flex-end}
  .card{border:1px solid #233048;background:#0e1524;border-radius:10px;padding:.6rem}
  .card h3{margin:.2rem 0 .4rem 0;font-size:1rem;color:#d7e4ff}
  .meSel{outline:2px solid #59db7d; box-shadow:0 0 0 4px rgba(89,219,125,.18)}
  .compSel{outline:2px solid #7aa2ff; box-shadow:0 0 0 4px rgba(122,162,255,.18)}

  /* Handouts */
  #handoutsList img{max-width:100%;height:auto;border:1px solid #1a2231;border-radius:8px;display:block;margin:.35rem 0}
  #handoutsList .ho{border:1px solid #223049;border-radius:10px;padding:.6rem;margin:.5rem 0;background:#0f1525}
  #handoutsList .ho h4{margin:.25rem 0 .3rem 0}

  /* Progress */
  #modalProgress .sheet{max-width:640px}
  .barWrap{height:14px;background:#0c131f;border:1px solid #202b41;border-radius:999px;overflow:hidden}
  .bar{
    height:100%;width:0%;
    background:linear-gradient(90deg,#7aa2ff,#86f0d1,#7aa2ff);
    background-size:200% 100%;
    animation:flow 1.4s linear infinite;
  }
  @keyframes flow { 0%{background-position:0% 50%} 100%{background-position:200% 50%} }
  .stepList{display:flex;flex-direction:column;gap:.35rem}
  .stepItem{display:flex;align-items:center;gap:.6rem}
  .stepItem .dot{width:10px;height:10px;border-radius:50%;background:#2a3650;border:1px solid #34476a}
  .stepItem.done .dot{background:#59db7d;border-color:#2e6a53}
  .stepItem.cur .dot{background:#7aa2ff;border-color:#4869a7}

  /* Save slots */
  .slots{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
  .slots .slot{display:flex;gap:.5rem;align-items:center;justify-content:space-between;border:1px dashed #2b3650;border-radius:10px;padding:.4rem .6rem;background:#0c121c}
  .slots .meta{display:flex;flex-direction:column}
  .slots .ts{font-size:.75rem;color:#8ea0bf}

  /* Toast */
  #toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0e1524;border:1px solid #223049;border-radius:10px;padding:.5rem .8rem;color:#cfe1ff;opacity:0;pointer-events:none;transition:opacity .25s;z-index:120}
  #toast.show{opacity:1}

  /* Initiative Thinking Indicator */
  @keyframes pulse { 0% { background-color: var(--accent); } 50% { background-color: var(--brand); } 100% { background-color: var(--accent); } }
  .thinking-indicator {
    display:inline-block;
    width:8px;height:8px;border-radius:50%;
    margin-left:8px;
    animation:pulse 1.5s infinite ease-in-out;
  }

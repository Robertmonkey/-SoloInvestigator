<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Solo Investigator — Tutorial Solo VTT</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header class="appbar">
  <h1>Solo Investigator</h1>
  <nav>
    <button id="btnSettings">Settings</button>
    <button id="btnWizard">Tutorial Wizard</button>
    <button id="btnScenes">Scenes</button>
    <button id="btnParty">Party</button>
    <button id="btnNPCs">NPCs</button>
    <button id="btnHandouts">Handouts</button>
    <button id="btnClues">Clues</button>
    <button id="btnSaveLoad">Save/Load</button>
    <span class="pill">Shortcuts: <span class="kbd">V</span> select · <span class="kbd">R</span> ruler · <span class="kbd">F</span> reveal · <span class="kbd">H</span> hide · <span class="kbd">U</span> undo · <span class="kbd">S</span> settings · <span class="kbd">P</span> party · <span class="kbd">L</span> save/load · <span class="kbd">?</span> help</span>
  </nav>
</header>

<div class="container">
  <section class="leftcol">
    <div class="panel">
      <h2>Keeper & Chat</h2>
      <div id="chat">
        <div id="chatLog"></div>
        <div id="chatEntry">
          <select id="cmdPicker" title="Quick Commands">
            <option value="">— Quick Commands —</option>
            <option value="/roll 1d100">Roll 1d100</option>
            <option value="/roll 1d20">Roll 1d20</option>
            <option value="/roll 3d6">Roll 3d6</option>
            <option value="/luck">Refresh Luck</option>
            <option value="/spendluck 5">Spend 5 Luck</option>
            <option value="/check Spot">Check Spot</option>
            <option value="/check Listen">Check Listen</option>
            <option value="/endturn">End Turn</option>
            <option value="/help">Help</option>
          </select>
          <button id="cmdInsert" class="ghost">Insert</button>
          <input id="chatInput" placeholder="Say something… (try /roll 1d100, /check Spot, /check Listen, /luck, /spendluck 5, /keeper What do we notice?)" />
          <button class="primary" id="chatSend">Send</button>
          <button class="ghost" id="btnAskKeeper" title="Ask Keeper without sending more tokens by default">Ask Keeper</button>
          <button class="ghost" id="btnStopVoice" title="Stop voices & clear queue">Stop Voice</button>
          <button class="ghost" id="btnCopyChat" title="Copy chat log to clipboard">Copy Chat</button>
          <button class="ghost" id="btnClearChat" title="Clear chat log">Clear Chat</button>
        </div>
        <div class="note small">Keeper replies only when you click <b>Ask Keeper</b> or use <b>/keeper …</b> (change in Settings → Trigger). Browser voices are free; ElevenLabs and OpenAI are cached to save tokens.</div>
      </div>
    </div>
  </section>

  <section class="panel" id="mapWrap">
    <h2>Map</h2>
    <div id="map">
      <div id="mapBg"></div>
      <div id="grid"></div>
      <canvas id="fog"></canvas>
      <canvas id="reach"></canvas>
    </div>
    <div class="row" style="margin-top:.5rem">
      <div class="pill">Tool:
        <select id="tool">
          <option value="select">Select/Move (V)</option>
          <option value="ruler">Ruler (R)</option>
          <option value="reveal">Fog: Reveal (F)</option>
          <option value="hide">Fog: Hide (H)</option>
        </select>
      </div>
      <div class="pill">Brush:
        <select id="brush">
          <option>1</option><option selected>2</option><option>3</option>
        </select>
      </div>
      <button id="btnUndo" class="ghost">Undo Fog (U)</button>
      <button id="btnToggleGrid" class="ghost">Toggle Grid (G)</button>
      <span class="pill">Grid: 12 × 8</span>
    </div>
  </section>

  <section class="rightcol">
    <div class="panel">
      <h2>Board Controls</h2>
      <div class="row">
        <button id="btnCenter" class="ghost">Center Tokens</button>
        <button id="btnParticles" class="ghost">Ping FX</button>
        <button id="btnGenBG" class="primary">Generate Background</button>
        <button id="btnOmen" class="ghost">Random Omen</button>
      </div>
      <div class="row" style="margin-top:.5rem">
        <button id="btnRevealAll" class="success">Reveal All</button>
        <button id="btnHideAll" class="danger">Hide All</button>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button id="btnNewScene" class="ghost">New Scene</button>
        <button id="btnSwitchScene" class="ghost">Switch Scene</button>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button id="btnStartEncounter" class="primary">Start Encounter</button>
        <button id="btnEndTurn" class="ghost">End Turn</button>
        <button id="btnEndEncounter" class="warn">End Encounter</button>
      </div>
      <div class="small">Scene: <span id="sceneName">Untitled</span></div>
      <div class="small">Turn: <span id="turnInfo">Free exploration</span></div>
    </div>

    <div class="panel">
      <h2>Initiative</h2>
      <div class="row">
        <button id="btnInitRoll" class="ghost">Roll All</button>
        <button id="btnInitNext" class="primary">Next Turn</button>
        <button id="btnInitClear" class="ghost">Clear</button>
      </div>
      <ol id="initList" class="small"></ol>
    </div>

    <div class="panel">
      <h2>Tokens</h2>
      <div id="tokenList" class="small"></div>
    </div>
  </section>
</div>

<!-- SETTINGS -->
<div class="modal" id="modalSettings">
  <div class="scrim" data-close="#modalSettings"></div>
  <div class="sheet">
    <h2>Settings</h2>
    <div class="grid2">
      <div class="col">
        <label>OpenAI API Key (optional)</label>
        <input id="openaiKey" placeholder="sk‑..." />
        <label>OpenAI Chat Model</label>
        <select id="openaiModel">
          <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
          <option value="gpt-4o">gpt-4o</option>
          <option value="o4-mini">o4-mini (if available)</option>
        </select>
        <label>Image Model</label>
        <select id="imageModel">
          <option value="dall-e-3" selected>dall-e-3</option>
          <option value="gpt-image-1">gpt-image-1</option>
          <option value="placeholders">Placeholders only (offline)</option>
        </select>
        <label><input type="checkbox" id="useImages" /> Enable Image Generation</label>
        <label><input type="checkbox" id="keeperOn" checked/> Keeper AI On</label>
        <label>Keeper Trigger</label>
        <select id="keeperTrigger">
          <option value="manual">Manual (Ask Keeper or /keeper)</option>
          <option value="auto" selected>Auto (every non-slash message)</option>
        </select>
        <label>Keeper Style</label>
        <select id="keeperStyle">
          <option value="brief">Brief</option>
          <option value="normal" selected>Normal</option>
          <option value="verbose">Verbose</option>
        </select>
        <label>Keeper Max Tokens</label>
        <input id="keeperMax" type="number" min="128" max="2000" value="450"/>
        <label>Theme</label>
        <select id="theme">
          <option value="dark" selected>Dark</option>
          <option value="light">Light</option>
        </select>
        <label><input type="checkbox" id="showTimestamps"/> Show chat timestamps</label>
        <label><input type="checkbox" id="autoScroll" checked/> Auto-scroll chat</label>
      </div>
      <div class="col">
        <label>TTS Provider (default)</label>
        <select id="ttsProviderDefault">
          <option value="browser" selected>Browser (free)</option>
          <option value="eleven">ElevenLabs</option>
          <option value="openai">OpenAI</option>
          <option value="none">None</option>
        </select>
        <label>ElevenLabs API Key</label>
        <input id="elevenKey" placeholder="eleven‑..." />
        <label>ElevenLabs Default Voice ID</label>
        <input id="voiceId" placeholder="e.g., 21m00Tcm4TlvDq8ikWAM" />
        <label>ElevenLabs TTS Model</label>
        <input id="elevenModel" placeholder="eleven_multilingual_v2" />
        <label>OpenAI TTS Model</label>
        <input id="openaiTTSModel" placeholder="gpt-4o-mini-tts" />
        <label>OpenAI Default Voice</label>
        <input id="openaiVoice" placeholder="alloy" />
        <label><input type="checkbox" id="ttsOn" /> Enable Voices</label>
        <label><input type="checkbox" id="ttsQueue" checked /> Queue voice (no overlaps)</label>
        <label>Voice Volume</label>
        <input id="voiceVolume" type="range" min="0" max="1" step="0.1" value="1" />
      </div>
    </div>
    <div class="hr"></div>
    <div class="col">
      <label>Rules Pack (optional, your notes only — no copyrighted text)</label>
      <textarea id="rulesPack" rows="5" placeholder="Your house rules / notes…"></textarea>
    </div>
    <div class="hr"></div>
    <div class="row right">
      <button class="ghost" id="btnResetSettings">Reset</button>
      <button class="ghost" data-close="#modalSettings">Close</button>
      <button class="primary" id="btnSaveSettings">Save</button>
    </div>
  </div>
</div>

<!-- WIZARD -->
<div class="modal" id="modalWizard">
  <div class="scrim" data-close="#modalWizard"></div>
  <div class="sheet">
    <h2>Tutorial: Learn to Play</h2>
    <div class="steps">
      <div class="step" id="wStep0B">1 · Settings</div>
      <div class="step" id="wStep1B">2 · Variety & Story Arc</div>
      <div class="step" id="wStep2B">3 · Pick + 4 Companions</div>
      <div class="step" id="wStep3B">4 · Auto‑Build</div>
      <div class="step" id="wStep4B">5 · Begin</div>
    </div>
    <div id="wizardBody"></div>
    <div class="hr"></div>
    <div class="row right">
      <button class="ghost" id="btnWizardBack">Back</button>
      <button class="primary" id="btnWizardNext">Next</button>
    </div>
  </div>
</div>

<!-- PROGRESS -->
<div class="modal" id="modalProgress">
  <div class="scrim"></div>
  <div class="sheet">
    <h2 id="progTitle">Building Your Table…</h2>
    <div class="barWrap"><div class="bar" id="progBar"></div></div>
    <div class="stepList" id="progSteps" style="margin-top:.6rem"></div>
    <div class="hr"></div>
    <div class="small" id="progNote">This runs entirely in your browser.</div>
  </div>
</div>

<!-- SCENES -->
<div class="modal" id="modalScenes">
  <div class="scrim" data-close="#modalScenes"></div>
  <div class="sheet">
    <h2>Scenes</h2>
    <div class="grid2">
      <div class="col">
        <label>Scene Name</label>
        <input id="sceneTitle" placeholder="Greyhaven Docks" />
        <label>Set Background (data URL)</label>
        <textarea id="sceneBgData" rows="4" placeholder="Paste data:image/png;base64,..."></textarea>
        <div class="row right"><button id="btnSetBG" class="ghost">Apply</button></div>
      </div>
      <div class="col">
        <label>Generate Background</label>
        <textarea id="bgPrompt" rows="6" placeholder="Gloomy archive stacks, dramatic light through dusty windows, painterly"></textarea>
        <div class="row right"><button id="btnGenBG2" class="primary">Generate</button></div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="col">
      <label>Scenes</label>
      <div id="sceneList" class="small"></div>
    </div>
    <div class="hr"></div>
    <div class="row right">
      <button class="ghost" data-close="#modalScenes">Close</button>
      <button class="primary" id="btnAddScene">Add Scene</button>
      <button class="warn" id="btnSwitchScene2">Switch</button>
    </div>
  </div>
</div>

<!-- PARTY -->
<div class="modal" id="modalParty">
  <div class="scrim" data-close="#modalParty"></div>
  <div class="sheet">
    <h2>Party (Investigators)</h2>
    <div class="row">
      <button id="btnGenParty" class="primary">Quick Generate 5</button>
      <button id="btnPortraits" class="ghost">Generate Portraits (all)</button>
      <button id="btnAddPC" class="ghost">Add PC</button>
    </div>
    <div id="partyList" class="small" style="margin-top:.5rem"></div>
    <div class="hr"></div>
    <div class="row right"><button class="ghost" data-close="#modalParty">Close</button></div>
  </div>
</div>

<!-- NPCS -->
<div class="modal" id="modalNPCs">
  <div class="scrim" data-close="#modalNPCs"></div>
  <div class="sheet">
    <h2>NPCs</h2>
    <div class="row">
      <button id="btnGenNPCs" class="primary">Add 4 Random NPCs</button>
      <button id="btnAddNPC" class="ghost">Add NPC</button>
    </div>
    <div id="npcList" class="small" style="margin-top:.5rem"></div>
    <div class="hr"></div>
    <div class="row right"><button class="ghost" data-close="#modalNPCs">Close</button></div>
</div>
</div>

<!-- HANDOUTS -->
<div class="modal" id="modalHandouts">
  <div class="scrim" data-close="#modalHandouts"></div>
  <div class="sheet">
    <h2>Handouts</h2>
    <div class="row">
      <button id="btnGenHandouts" class="primary">Generate Handouts</button>
    </div>
    <div id="handoutsList" class="small" style="margin-top:.5rem"></div>
    <div class="hr"></div>
    <div class="row right"><button class="ghost" data-close="#modalHandouts">Close</button></div>
</div>
</div>

<!-- CLUES -->
<div class="modal" id="modalClues">
  <div class="scrim" data-close="#modalClues"></div>
  <div class="sheet">
    <h2>Clue Journal</h2>
    <div id="clueList" class="col" style="margin-bottom:.5rem"></div>
    <div class="row" style="margin-top:.5rem">
      <input id="clueTitle" placeholder="Title"/>
      <input id="clueText" placeholder="Details"/>
      <button id="btnAddClue" class="ghost">Add</button>
    </div>
    <div class="hr"></div>
    <div class="row right"><button class="ghost" data-close="#modalClues">Close</button></div>
  </div>
</div>

<!-- SAVE/LOAD -->
<div class="modal" id="modalSave">
  <div class="scrim" data-close="#modalSave"></div>
  <div class="sheet">
    <h2>Save / Load</h2>
    <div class="slots" id="slots"></div>
    <div class="hr"></div>
    <div class="grid2">
      <div class="col">
        <label>Export (download JSON file)</label>
        <button id="btnExport" class="ghost">Export Current</button>
        <button id="btnExportSlots" class="ghost" style="margin-top:.5rem">Export Slots</button>
      </div>
      <div class="col">
        <label>Import (paste JSON)</label>
        <textarea id="importText" rows="6" placeholder="{...}"></textarea>
        <div class="row right"><button id="btnImport" class="primary">Import Text</button></div>
        <label style="margin-top:.5rem">Import from File</label>
        <input id="importFile" type="file" accept="application/json"/>
        <label style="margin-top:.5rem">Import Slots File</label>
        <input id="importSlotsFile" type="file" accept="application/json"/>
      </div>
    </div>
  </div>
</div>

<!-- HELP -->
<div class="modal" id="modalHelp">
  <div class="scrim" data-close="#modalHelp"></div>
  <div class="sheet">
    <h2>Help & Shortcuts</h2>
    <div class="small">
      <p><span class="kbd">V</span> select · <span class="kbd">R</span> ruler · <span class="kbd">F</span> reveal · <span class="kbd">H</span> hide · <span class="kbd">U</span> undo</p>
      <p><span class="kbd">S</span> settings · <span class="kbd">P</span> party · <span class="kbd">L</span> save/load · <span class="kbd">?</span> help</p>
      <p>Chat commands: /roll NdM±K · /check Skill · /luck · /spendluck N · /keeper question · /endturn</p>
    </div>
    <div class="hr"></div>
    <div class="row right"><button class="ghost" data-close="#modalHelp">Close</button></div>
  </div>
</div>

<!-- CHARACTER SHEET -->
<div class="modal" id="modalSheet">
  <div class="scrim" data-close="#modalSheet"></div>
  <div class="sheet">
    <h2 id="sheetTitle">Character Sheet</h2>
    <div class="grid2">
      <div class="card">
        <h3>Identity</h3>
        <div class="col">
          <label>Name</label>
          <input id="csName"/>
          <label>Archetype</label>
          <input id="csArch"/>
          <label>Persona / Notes</label>
          <textarea id="csPersona" rows="4"></textarea>
          <label>Bonds</label>
          <input id="csBonds" placeholder="family, debts"/>
        </div>
      </div>
      <div class="card">
        <h3>Vitals</h3>
        <div class="grid4">
          <div class="col"><label>HP</label><input id="csHP" type="number" min="0"/></div>
          <div class="col"><label>Sanity</label><input id="csSAN" type="number" min="0"/></div>
          <div class="col"><label>Speed</label><input id="csSPD" type="number" min="1"/></div>
          <div class="col"><label>Luck</label><div class="row"><input id="csLuck" type="number" min="0"/><button class="ghost" id="btnRollLuck">Roll</button></div></div>
        </div>
        <div class="hr"></div>
        <div class="grid3">
          <div class="col"><label>Brains</label><input id="csBrains" type="number" min="1"/></div>
          <div class="col"><label>Brawn</label><input id="csBrawn" type="number" min="1"/></div>
          <div class="col"><label>Nerve</label><input id="csNerve" type="number" min="1"/></div>
          <div class="col"><label>Perception</label><input id="csPerc" type="number" min="1"/></div>
          <div class="col"><label>Charm</label><input id="csCharm" type="number" min="1"/></div>
        </div>
        <div class="hr"></div>
        <label>Conditions (comma separated)</label>
        <input id="csConds" placeholder="wounded, rattled"/>
      </div>
    </div>

    <div class="hr"></div>

    <div class="grid2">
      <div class="card">
        <h3>Skills</h3>
        <div id="csSkills" class="col"></div>
        <div class="row" style="margin-top:.5rem">
          <input id="csSkillName" placeholder="Skill name"/>
          <input id="csSkillVal" type="number" min="1" max="99" placeholder="50"/>
          <button class="ghost" id="btnAddSkill">Add/Update</button>
        </div>
      </div>
      <div class="card">
        <h3>Inventory</h3>
        <div id="csInv" class="col"></div>
        <div class="row" style="margin-top:.5rem">
          <input id="csItemName" placeholder="Item name"/>
          <input id="csItemQty" type="number" min="1" value="1"/>
          <input id="csItemWt" type="number" min="0" step="0.1" value="0"/>
          <button class="ghost" id="btnAddItem">Add</button>
        </div>
        <div class="small" id="invWeight">Weight: 0</div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="row right">
      <button class="ghost" data-close="#modalSheet">Close</button>
      <button class="primary" id="btnSheetSave">Save</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script src="js/keeper.js"></script>
<script src="js/app.js"></script>
</body>
</html>

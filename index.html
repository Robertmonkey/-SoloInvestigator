<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Solo Investigator — Tutorial Solo VTT</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121821; --panel-2:#0f151e; --ink:#e9eef7; --muted:#a7b0c0;
    --brand:#7aa2ff; --accent:#86f0d1; --danger:#ff6b6b; --warn:#ffc04d; --ok:#59db7d;
    --grid:#1c2230; --grid-2:#151a25; --glow:0 0 20px rgba(122,162,255,.25);
    --pc:#2e6a53; --npc:#5a365a; --keeper:#1f2a44;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:radial-gradient(1200px 700px at 70% -10%,#182134 0,#0b0e12 55%,#070a0f 100%);
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    letter-spacing:.15px;
  }
  a{color:var(--brand)}
  button,select,input,textarea{
    background:var(--panel); color:var(--ink); border:1px solid #212a3b; border-radius:8px; padding:.6rem .75rem
  }
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg,#1f2a44,#152037);border-color:#31405c;box-shadow:var(--glow)}
  button.ghost{background:transparent;border-color:#2a3345}
  button.warn{background:linear-gradient(180deg,#3a2a10,#2a1e0a);border-color:#624314;color:#ffd98a}
  button.danger{background:linear-gradient(180deg,#3a1111,#260b0b);border-color:#652626;color:#ffc8c8}
  button.success{background:linear-gradient(180deg,#0f2a1a,#0a2014);border-color:#26543c;color:#b2ffd2}
  label{font-size:.9rem;color:var(--muted)}
  .row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
  .col{display:flex;flex-direction:column;gap:.5rem}
  .pill{display:inline-flex;align-items:center;gap:.5rem;padding:.2rem .55rem;border-radius:999px;background:#151b27;border:1px solid #2a3345;color:#b6c2d8;font-size:.8rem}
  .tag{font-size:.75rem;color:#9cadc6;background:#101521;border:1px solid #263147;border-radius:6px;padding:.2rem .4rem}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;border:1px solid #2a3345;background:#0d1220;border-radius:6px;padding:.1rem .35rem;color:#b9c7e6}

  header.appbar{
    position:sticky;top:0;z-index:50;background:rgba(10,14,20,.9);backdrop-filter:blur(6px);
    border-bottom:1px solid #1b2332;display:flex;align-items:center;gap:1rem;padding:.75rem 1rem
  }
  header.appbar h1{margin:0;font-size:1rem;letter-spacing:.12rem;text-transform:uppercase;color:#bcd1ff}
  header.appbar nav{display:flex;gap:.5rem;flex-wrap:wrap}
  header.appbar nav button{padding:.45rem .6rem}

  .container{display:grid;grid-template-columns:320px 1fr 360px;gap:1rem;padding:1rem;align-items:stretch}
  @media (max-width: 1100px){ .container{grid-template-columns:1fr} }

  .panel{background:linear-gradient(180deg, var(--panel), var(--panel-2));border:1px solid #1a2130;border-radius:12px;padding:1rem;box-shadow:var(--glow)}
  .panel h2{margin:.25rem 0 1rem 0;font-size:1rem;color:#c9d6f7}
  .leftcol,.rightcol{display:flex;flex-direction:column;gap:1rem}

  /* Map */
  #mapWrap{position:relative;border-radius:12px;overflow:hidden}
  #map{position:relative;aspect-ratio:3/2;background:
      linear-gradient(0deg, rgba(0,0,0,.25), rgba(0,0,0,.25)),
      radial-gradient(1200px 800px at 80% -10%,rgba(134,240,209,.04),transparent 60%),
      #0c1119;
    outline:1px solid #1a2130}
  #mapBg{position:absolute;inset:0;background-size:cover;background-position:center;filter:contrast(1.02) saturate(1.02) brightness(.9)}
  #grid{position:absolute;inset:0;background-image:
      linear-gradient(to right, var(--grid) 1px, transparent 1px),
      linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
    background-size:calc(100%/12) calc(100%/8);mix-blend-mode:overlay;opacity:.9;pointer-events:none}
  #fog{position:absolute;inset:0;pointer-events:none}
  #reach{position:absolute;inset:0;pointer-events:none}

  .token{
    position:absolute; width:calc(100%/12); height:calc(100%/8);
    transform:translate(-50%,-50%); display:flex; align-items:center; justify-content:center; transition:transform .25s ease;
  }
  .token .bubble{
    width:60%; aspect-ratio:1/1; border-radius:50%; border:2px solid #25324a;
    background:radial-gradient(50% 50% at 30% 30%, #415379, #1a2333);
    display:flex;align-items:center;justify-content:center;overflow:hidden; box-shadow:0 4px 16px rgba(0,0,0,.4);
  }
  .token img{width:100%;height:100%;object-fit:cover;border-radius:50%}
  .token .letters{font-weight:700;color:#d8e4ff}
  .token.pc .bubble{background:radial-gradient(50% 50% at 30% 30%, var(--pc), #15251f)}
  .token.npc .bubble{background:radial-gradient(50% 50% at 30% 30%, var(--npc), #1f1521)}
  .token.active-turn .bubble{box-shadow:0 0 12px 2px var(--accent);border-color:var(--accent)}
  .token .cap{position:absolute;bottom:-.25rem;left:50%;transform:translateX(-50%);
    font-size:.7rem;background:#0e1421;border:1px solid #223049;border-radius:6px;padding:.05rem .35rem;color:#cfe1ff}

  .measure{position:absolute;border-top:2px dashed #6ea2ff;pointer-events:none;transform-origin:0 0}
  .measure .label{position:absolute;top:-1.35rem;right:-.25rem;background:#0e1626;border:1px solid #24324c;border-radius:8px;padding:.1rem .35rem;
    color:#cfe1ff;font-size:.75rem}

  /* Chat (fixed height + scrollbar) */
  #chat{display:flex;flex-direction:column;height:100%}
  #chatLog{
    flex:1; /* fill remaining space */
    overflow-y:auto;
    min-height:0;
    background:#0c121d;border:1px solid #1a2130;border-radius:8px;padding:.75rem;scroll-behavior:smooth;
  }
  #chatLog .line{display:flex;align-items:flex-start;gap:.6rem;margin:.45rem 0}
  #chatLog .line.action{font-style:italic;color:var(--muted);background:#0c121d;border-radius:4px;padding:.2rem .4rem}
  #chatLog .line.system{color:var(--muted)}
  #chatLog .who{opacity:.85;font-weight:600}
  #chatLog .content{flex:1}
  #chatLog .controls{display:flex;gap:.25rem}
  #chatLog .keeper .who{color:#bcd1ff}
  #chatLog .you .who{color:#d5f7e7}
  .avatar{width:28px;height:28px;border-radius:50%;overflow:hidden;border:1px solid #223049;flex:none}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .speakerName{font-weight:700}
  #chatEntry{display:flex;gap:.5rem;margin-top:.5rem;flex-wrap:wrap}
  #chatEntry input{flex:1;min-width:220px}
  #chatEntry button{white-space:nowrap}

  .note{font-size:.85rem;color:#a6b4cc}

  /* Modals */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:90}
  .modal.show{display:flex}
  .modal .scrim{position:absolute;inset:0;background:rgba(6,8,12,.75);backdrop-filter:blur(6px)}
  .modal .sheet{position:relative;max-width:1100px;width:min(1100px,96vw);max-height:90vh;overflow:auto;border-radius:14px;
    background:linear-gradient(180deg,#0d1220,#0a0f19);border:1px solid #1a2231;padding:1rem;box-shadow:0 10px 40px rgba(0,0,0,.5)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.75rem}
  .thin{font-weight:500;color:#b6c1d6}
  .small{font-size:.85rem;color:#9fb0c8}
  .hr{height:1px;background:#1b2333;margin:.75rem 0}
  .right{justify-content:flex-end}
  .card{border:1px solid #233048;background:#0e1524;border-radius:10px;padding:.6rem}
  .card h3{margin:.2rem 0 .4rem 0;font-size:1rem;color:#d7e4ff}
  .meSel{outline:2px solid #59db7d; box-shadow:0 0 0 4px rgba(89,219,125,.18)}
  .compSel{outline:2px solid #7aa2ff; box-shadow:0 0 0 4px rgba(122,162,255,.18)}

  /* Handouts */
  #handoutsList img{max-width:100%;height:auto;border:1px solid #1a2231;border-radius:8px;display:block;margin:.35rem 0}
  #handoutsList .ho{border:1px solid #223049;border-radius:10px;padding:.6rem;margin:.5rem 0;background:#0f1525}
  #handoutsList .ho h4{margin:.25rem 0 .3rem 0}

  /* Progress */
  #modalProgress .sheet{max-width:640px}
  .barWrap{height:14px;background:#0c131f;border:1px solid #202b41;border-radius:999px;overflow:hidden}
  .bar{
    height:100%;width:0%;
    background:linear-gradient(90deg,#7aa2ff,#86f0d1,#7aa2ff);
    background-size:200% 100%;
    animation:flow 1.4s linear infinite;
  }
  @keyframes flow { 0%{background-position:0% 50%} 100%{background-position:200% 50%} }
  .stepList{display:flex;flex-direction:column;gap:.35rem}
  .stepItem{display:flex;align-items:center;gap:.6rem}
  .stepItem .dot{width:10px;height:10px;border-radius:50%;background:#2a3650;border:1px solid #34476a}
  .stepItem.done .dot{background:#59db7d;border-color:#2e6a53}
  .stepItem.cur .dot{background:#7aa2ff;border-color:#4869a7}

  /* Save slots */
  .slots{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
  .slots .slot{display:flex;gap:.5rem;align-items:center;justify-content:space-between;border:1px dashed #2b3650;border-radius:10px;padding:.4rem .6rem;background:#0c121c}
  .slots .meta{display:flex;flex-direction:column}
  .slots .ts{font-size:.75rem;color:#8ea0bf}

  /* Toast */
  #toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0e1524;border:1px solid #223049;border-radius:10px;padding:.5rem .8rem;color:#cfe1ff;opacity:0;pointer-events:none;transition:opacity .25s;z-index:120}
  #toast.show{opacity:1}

  /* Initiative Thinking Indicator */
  @keyframes pulse { 0% { background-color: var(--accent); } 50% { background-color: var(--brand); } 100% { background-color: var(--accent); } }
  .thinking-indicator {
    display:inline-block;
    width:8px;height:8px;border-radius:50%;
    margin-left:8px;
    animation:pulse 1.5s infinite ease-in-out;
  }
</style>
</head>
<body>
<header class="appbar">
  <h1>Solo Investigator</h1>
  <nav>
    <button id="btnSettings">Settings</button>
    <button id="btnWizard">Tutorial Wizard</button>
    <button id="btnScenes">Scenes</button>
    <button id="btnParty">Party</button>
    <button id="btnNPCs">NPCs</button>
    <button id="btnHandouts">Handouts</button>
    <button id="btnSaveLoad">Save/Load</button>
    <span class="pill">Shortcuts: <span class="kbd">V</span> select · <span class="kbd">R</span> ruler · <span class="kbd">F</span> reveal · <span class="kbd">H</span> hide · <span class="kbd">U</span> undo</span>
  </nav>
</header>

<div class="container">
  <section class="leftcol">
    <div class="panel">
      <h2>Keeper & Chat</h2>
      <div id="chat">
        <div id="chatLog"></div>
        <div id="chatEntry">
          <select id="cmdPicker" title="Quick Commands">
            <option value="">— Quick Commands —</option>
            <option value="/roll 1d100">Roll 1d100</option>
            <option value="/roll 1d20">Roll 1d20</option>
            <option value="/roll 3d6">Roll 3d6</option>
            <option value="/check Spot 60">Check Spot 60</option>
            <option value="/endturn">End Turn</option>
            <option value="/help">Help</option>
          </select>
          <button id="cmdInsert" class="ghost">Insert</button>
          <input id="chatInput" placeholder="Say something… (try /roll 1d100, /check Spot 60, /keeper What do we notice?)" />
          <button class="primary" id="chatSend">Send</button>
          <button class="ghost" id="btnAskKeeper" title="Ask Keeper without sending more tokens by default">Ask Keeper</button>
          <button class="ghost" id="btnStopVoice" title="Stop voices & clear queue">Stop Voice</button>
        </div>
        <div class="note small">Keeper replies only when you click <b>Ask Keeper</b> or use <b>/keeper …</b> (change in Settings → Trigger). Browser voices are free; ElevenLabs is cached to save tokens.</div>
      </div>
    </div>
  </section>

  <section class="panel" id="mapWrap">
    <h2>Map</h2>
    <div id="map">
      <div id="mapBg"></div>
      <div id="grid"></div>
      <canvas id="fog"></canvas>
      <canvas id="reach"></canvas>
    </div>
    <div class="row" style="margin-top:.5rem">
      <div class="pill">Tool:
        <select id="tool">
          <option value="select">Select/Move (V)</option>
          <option value="ruler">Ruler (R)</option>
          <option value="reveal">Fog: Reveal (F)</option>
          <option value="hide">Fog: Hide (H)</option>
        </select>
      </div>
      <div class="pill">Brush:
        <select id="brush">
          <option>1</option><option selected>2</option><option>3</option>
        </select>
      </div>
      <button id="btnUndo" class="ghost">Undo Fog (U)</button>
      <span class="pill">Grid: 12 × 8</span>
    </div>
  </section>

  <section class="rightcol">
    <div class="panel">
      <h2>Board Controls</h2>
      <div class="row">
        <button id="btnCenter" class="ghost">Center Tokens</button>
        <button id="btnParticles" class="ghost">Ping FX</button>
        <button id="btnGenBG" class="primary">Generate Background</button>
      </div>
      <div class="row" style="margin-top:.5rem">
        <button id="btnRevealAll" class="success">Reveal All</button>
        <button id="btnHideAll" class="danger">Hide All</button>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button id="btnNewScene" class="ghost">New Scene</button>
        <button id="btnSwitchScene" class="ghost">Switch Scene</button>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button id="btnStartEncounter" class="primary">Start Encounter</button>
        <button id="btnEndTurn" class="ghost">End Turn</button>
        <button id="btnEndEncounter" class="warn">End Encounter</button>
      </div>
      <div class="small">Scene: <span id="sceneName">Untitled</span></div>
      <div class="small">Turn: <span id="turnInfo">Free exploration</span></div>
    </div>

    <div class="panel">
      <h2>Initiative</h2>
      <div class="row">
        <button id="btnInitRoll" class="ghost">Roll All</button>
        <button id="btnInitNext" class="primary">Next Turn</button>
        <button id="btnInitClear" class="ghost">Clear</button>
      </div>
      <ol id="initList" class="small"></ol>
    </div>

    <div class="panel">
      <h2>Tokens</h2>
      <div id="tokenList" class="small"></div>
    </div>
  </section>
</div>

<!-- SETTINGS -->
<div class="modal" id="modalSettings">
  <div class="scrim" data-close="#modalSettings"></div>
  <div class="sheet">
    <h2>Settings</h2>
    <div class="grid2">
      <div class="col">
        <label>OpenAI API Key (optional)</label>
        <input id="openaiKey" placeholder="sk‑..." />
        <label>OpenAI Chat Model</label>
        <select id="openaiModel">
          <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
          <option value="gpt-4o">gpt-4o</option>
          <option value="o4-mini">o4-mini (if available)</option>
        </select>
        <label>Image Model</label>
        <select id="imageModel">
          <option value="dall-e-3" selected>dall-e-3</option>
          <option value="gpt-image-1">gpt-image-1</option>
          <option value="placeholders">Placeholders only (offline)</option>
        </select>
        <label><input type="checkbox" id="useImages" /> Enable Image Generation</label>
        <label><input type="checkbox" id="keeperOn" checked/> Keeper AI On</label>
        <label>Keeper Trigger</label>
        <select id="keeperTrigger">
          <option value="manual" selected>Manual (Ask Keeper or /keeper)</option>
          <option value="auto">Auto (every non-slash message)</option>
        </select>
        <label>Keeper Style</label>
        <select id="keeperStyle">
          <option value="brief">Brief</option>
          <option value="normal" selected>Normal</option>
          <option value="verbose">Verbose</option>
        </select>
        <label>Keeper Max Tokens</label>
        <input id="keeperMax" type="number" min="128" max="2000" value="450"/>
      </div>
      <div class="col">
        <label>TTS Provider (default)</label>
        <select id="ttsProviderDefault">
          <option value="browser" selected>Browser (free)</option>
          <option value="eleven">ElevenLabs</option>
          <option value="none">None</option>
        </select>
        <label>ElevenLabs API Key</label>
        <input id="elevenKey" placeholder="eleven‑..." />
        <label>ElevenLabs Default Voice ID</label>
        <input id="voiceId" placeholder="e.g., 21m00Tcm4TlvDq8ikWAM" />
        <label><input type="checkbox" id="ttsOn" /> Enable Voices</label>
        <label><input type="checkbox" id="ttsQueue" checked /> Queue voice (no overlaps)</label>
      </div>
    </div>
    <div class="hr"></div>
    <div class="col">
      <label>Rules Pack (optional, your notes only — no copyrighted text)</label>
      <textarea id="rulesPack" rows="5" placeholder="Your house rules / notes…"></textarea>
    </div>
    <div class="hr"></div>
    <div class="row right">
      <button class="ghost" data-close="#modalSettings">Close</button>
      <button class="primary" id="btnSaveSettings">Save</button>
    </div>
  </div>
</div>

<!-- WIZARD -->
<div class="modal" id="modalWizard">
  <div class="scrim" data-close="#modalWizard"></div>
  <div class="sheet">
    <h2>Tutorial: Learn to Play</h2>
    <div class="steps">
      <div class="step" id="wStep0B">1 · Settings</div>
      <div class="step" id="wStep1B">2 · Variety & Story Arc</div>
      <div class="step" id="wStep2B">3 · Pick + 4 Companions</div>
      <div class="step" id="wStep3B">4 · Auto‑Build</div>
      <div class="step" id="wStep4B">5 · Begin</div>
    </div>
    <div id="wizardBody"></div>
    <div class="hr"></div>
    <div class="row right">
      <button class="ghost" id="btnWizardBack">Back</button>
      <button class="primary" id="btnWizardNext">Next</button>
    </div>
  </div>
</div>

<!-- PROGRESS -->
<div class="modal" id="modalProgress">
  <div class="scrim"></div>
  <div class="sheet">
    <h2 id="progTitle">Building Your Table…</h2>
    <div class="barWrap"><div class="bar" id="progBar"></div></div>
    <div class="stepList" id="progSteps" style="margin-top:.6rem"></div>
    <div class="hr"></div>
    <div class="small" id="progNote">This runs entirely in your browser.</div>
  </div>
</div>

<!-- SCENES -->
<div class="modal" id="modalScenes">
  <div class="scrim" data-close="#modalScenes"></div>
  <div class="sheet">
    <h2>Scenes</h2>
    <div class="grid2">
      <div class="col">
        <label>Scene Name</label>
        <input id="sceneTitle" placeholder="Greyhaven Docks" />
        <label>Set Background (data URL)</label>
        <textarea id="sceneBgData" rows="4" placeholder="Paste data:image/png;base64,..."></textarea>
        <div class="row right"><button id="btnSetBG" class="ghost">Apply</button></div>
      </div>
      <div class="col">
        <label>Generate Background</label>
        <textarea id="bgPrompt" rows="6" placeholder="Gloomy archive stacks, dramatic light through dusty windows, painterly"></textarea>
        <div class="row right"><button id="btnGenBG2" class="primary">Generate</button></div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="col">
      <label>Scenes</label>
      <div id="sceneList" class="small"></div>
    </div>
    <div class="hr"></div>
    <div class="row right">
      <button class="ghost" data-close="#modalScenes">Close</button>
      <button class="primary" id="btnAddScene">Add Scene</button>
      <button class="warn" id="btnSwitchScene2">Switch</button>
    </div>
  </div>
</div>

<!-- PARTY -->
<div class="modal" id="modalParty">
  <div class="scrim" data-close="#modalParty"></div>
  <div class="sheet">
    <h2>Party (Investigators)</h2>
    <div class="row">
      <button id="btnGenParty" class="primary">Quick Generate 5</button>
      <button id="btnPortraits" class="ghost">Generate Portraits (all)</button>
      <button id="btnAddPC" class="ghost">Add PC</button>
    </div>
    <div id="partyList" class="small" style="margin-top:.5rem"></div>
    <div class="hr"></div>
    <div class="row right"><button class="ghost" data-close="#modalParty">Close</button></div>
  </div>
</div>

<!-- NPCS -->
<div class="modal" id="modalNPCs">
  <div class="scrim" data-close="#modalNPCs"></div>
  <div class="sheet">
    <h2>NPCs</h2>
    <div class="row">
      <button id="btnGenNPCs" class="primary">Add 4 Random NPCs</button>
      <button id="btnAddNPC" class="ghost">Add NPC</button>
    </div>
    <div id="npcList" class="small" style="margin-top:.5rem"></div>
    <div class="hr"></div>
    <div class="row right"><button class="ghost" data-close="#modalNPCs">Close</button></div>
  </div>
</div>

<!-- HANDOUTS -->
<div class="modal" id="modalHandouts">
  <div class="scrim" data-close="#modalHandouts"></div>
  <div class="sheet">
    <h2>Handouts</h2>
    <div class="row">
      <button id="btnGenHandouts" class="primary">Generate Handouts</button>
    </div>
    <div id="handoutsList" class="small" style="margin-top:.5rem"></div>
    <div class="hr"></div>
    <div class="row right"><button class="ghost" data-close="#modalHandouts">Close</button></div>
  </div>
</div>

<!-- SAVE/LOAD -->
<div class="modal" id="modalSave">
  <div class="scrim" data-close="#modalSave"></div>
  <div class="sheet">
    <h2>Save / Load</h2>
    <div class="row" style="margin-bottom:.5rem">
      <button id="btnSave" class="ghost">Save</button>
      <button id="btnLoad" class="warn">Load</button>
    </div>
    <div class="slots" id="slots"></div>
    <div class="hr"></div>
    <div class="grid2">
      <div class="col">
        <label>Export (download JSON file)</label>
        <button id="btnExport" class="ghost">Export Now</button>
      </div>
      <div class="col">
        <label>Import (paste JSON)</label>
        <textarea id="importText" rows="6" placeholder="{...}"></textarea>
        <div class="row right"><button id="btnImport" class="primary">Import</button></div>
      </div>
    </div>
  </div>
</div>

<!-- CHARACTER SHEET -->
<div class="modal" id="modalSheet">
  <div class="scrim" data-close="#modalSheet"></div>
  <div class="sheet">
    <h2 id="sheetTitle">Character Sheet</h2>
    <div class="grid2">
      <div class="card">
        <h3>Identity</h3>
        <div class="col">
          <label>Name</label>
          <input id="csName"/>
          <label>Archetype</label>
          <input id="csArch"/>
          <label>Persona / Notes</label>
          <textarea id="csPersona" rows="4"></textarea>
        </div>
      </div>
      <div class="card">
        <h3>Vitals</h3>
        <div class="grid3">
          <div class="col"><label>HP</label><input id="csHP" type="number" min="0"/></div>
          <div class="col"><label>Sanity</label><input id="csSAN" type="number" min="0"/></div>
          <div class="col"><label>Speed</label><input id="csSPD" type="number" min="1"/></div>
        </div>
        <div class="hr"></div>
        <div class="grid3">
          <div class="col"><label>Brains</label><input id="csBrains" type="number" min="1"/></div>
          <div class="col"><label>Brawn</label><input id="csBrawn" type="number" min="1"/></div>
          <div class="col"><label>Nerve</label><input id="csNerve" type="number" min="1"/></div>
          <div class="col"><label>Perception</label><input id="csPerc" type="number" min="1"/></div>
          <div class="col"><label>Charm</label><input id="csCharm" type="number" min="1"/></div>
        </div>
        <div class="hr"></div>
        <label>Conditions (comma separated)</label>
        <input id="csConds" placeholder="wounded, rattled"/>
      </div>
    </div>

    <div class="hr"></div>

    <div class="grid2">
      <div class="card">
        <h3>Skills</h3>
        <div id="csSkills" class="col"></div>
        <div class="row" style="margin-top:.5rem">
          <input id="csSkillName" placeholder="Skill name"/>
          <input id="csSkillVal" type="number" min="1" max="99" placeholder="50"/>
          <button class="ghost" id="btnAddSkill">Add/Update</button>
        </div>
      </div>
      <div class="card">
        <h3>Inventory</h3>
        <div id="csInv" class="col"></div>
        <div class="row" style="margin-top:.5rem">
          <input id="csItemName" placeholder="Item name"/>
          <input id="csItemQty" type="number" min="1" value="1"/>
          <input id="csItemWt" type="number" min="0" step="0.1" value="0"/>
          <button class="ghost" id="btnAddItem">Add</button>
        </div>
        <div class="small" id="invWeight">Weight: 0</div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="row right">
      <button class="ghost" data-close="#modalSheet">Close</button>
      <button class="primary" id="btnSheetSave">Save</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* =========================================================
   SOLO INVESTIGATOR — Tutorial Solo VTT (client‑only)
   Token‑frugal, with Character Sheets + Inventory, stable chat scroll,
   asset‑full saves, manual Keeper trigger, stronger variety
   ========================================================= */

/* ---------- CONSTANTS ---------- */
const LS_SETTINGS = 'si_settings_v8';
const LS_SLOTS    = 'si_slots_v6';
const LS_QUICK    = 'si_quicksave_v1';
const LS_WIZARD   = 'si_wizard_done_v6';
const LS_ARC_FP   = 'si_recent_arc_fps_v2';
const GRID_W = 12, GRID_H = 8;

/* Ten core investigators (as before) */
const INVESTIGATORS = [
  { archetype:"Journalist", name:"Eleanor Shaw", prompt:"1920s journalist portrait, trench coat, press badge, film-noir lighting", backstory:"Reporter chasing labor abuses to redeem a career-stalling misquote.", traits:"Observant, stubborn, empathetic." },
  { archetype:"Doctor", name:"Thomas Greer, MD", prompt:"1920s physician portrait, wireframe glasses, soft rim light", backstory:"War medic haunted by triage choices; volunteers at a charity clinic.", traits:"Calm, clinical, moral." },
  { archetype:"Professor", name:"Miriam Kline", prompt:"1920s academic portrait, tweed, library bokeh", backstory:"Folklore professor cataloging 'drowned saints' myths.", traits:"Curious, cautious, enthralled." },
  { archetype:"Detective", name:"Silas Hart", prompt:"1920s sleuth portrait, fedora, cigarette smoke", backstory:"Laid‑off Pinkerton with a code; hired off‑books to find the missing.", traits:"Dry wit, methodical, suspicious." },
  { archetype:"Occultist", name:"Opal Reyes", prompt:"1920s medium portrait, candlelight, ectoplasmic haze", backstory:"Spiritualist who lost a sibling to the unknown; drawn to thin places.", traits:"Intense, intuitive, brittle." },
  { archetype:"Photographer", name:"Beatrice “Bea” Hollis", prompt:"1920s field photographer, Graflex camera, raincoat", backstory:"Stringer who captured something impossible on a glass plate.", traits:"Composed, daring, curious." },
  { archetype:"Sailor", name:"Franklin “Finn” MacReady", prompt:"1920s sailor portrait, peacoat, stormy backdrop", backstory:"Knows hidden inlets; talks in his sleep—answers back, too.", traits:"Superstitious, brave, practical." },
  { archetype:"Psychiatrist", name:"Dr. Anjali Rao", prompt:"1920s psychiatrist, tidy bob, notebook", backstory:"Researching mass suggestion; her mentor vanished here.", traits:"Analytical, patient, fearless." },
  { archetype:"Ex‑Priest", name:"Father Declan Byrne", prompt:"1920s clerical portrait, worn collar, hard eyes", backstory:"Left the cloth after a catastrophe; now studies apocrypha.", traits:"Grim, protective, resolute." },
  { archetype:"Radio Operator", name:"Dorothy “Dot” Pennington", prompt:"1920s radio operator, headphones, desk lamp glow", backstory:"Intercepted a coded transmission about 'the Chapel Below'.", traits:"Wry, quick, technical." }
];

/* Demo arcs (varied) */
const DEMO_ARCS = [
  {
    title:"Dust on the Stacks",
    logline:"At a university archive, a sealed collection keeps re-shelving itself. The cataloger who found it now speaks in someone else’s voice.",
    tone:"Scholarly dread; whispering stacks; sudden breaks of mania.",
    setting:"1926, Inland university library complex.",
    acts:[
      {name:"Act I — The Moved Books",beats:["Night staff hear reshelving in a locked room.","A call number line repeats a date that hasn't happened."]},
      {name:"Act II — The Deed Box",beats:["A sealed donor box smells like ozone.","A marginalia cipher points to an off‑limits sub‑basement."]},
      {name:"Act III — The Reading",beats:["An index card tray forms a sigil.","Stop a reading that writes itself into the audience."]}
    ],
    imagePrompts:[
      "Dusty archive stacks at night, beams of light, painterly, cinematic",
      "Sub-basement with pipes and index card cabinets, moody chiaroscuro",
      "Reading room with scattered papers and an ozone glow, 1920s"
    ],
    pcOptions: INVESTIGATORS,
    npcs:["Head Librarian with ink-stained fingers","Night Watchman who forgets his own name","Graduate Assistant with shaking hands","Archivist with a bandaged ear"]
  },
  {
    title:"Salt Less Taken",
    logline:"A mountain mining town reports echoes that answer back. The last surveyor’s maps keep changing when no one looks.",
    tone:"Lonely alpine dread; rumbling earth; lamps flicker in gusts.",
    setting:"1927, Mountain mining town and shafts.",
    acts:[
      {name:"Act I — The Second Echo",beats:["A voice repeats questions in the tunnels—wrong answers.","A drift wall is warm to the touch."]},
      {name:"Act II — Collapse of Names",beats:["Census records swap surnames overnight.","A surveyor’s map shows a tunnel that doesn’t exist—yet."]},
      {name:"Act III — The Hollow Men",beats:["Miners accuse each other of being 'wrong copies'.","A cavern roof pulses like a lung."]}
    ],
    imagePrompts:[
      "1920s mountain mine adit, lantern light, dust motes, painterly",
      "Town census office with scattered ledgers, twilight through window",
      "Large cavern with timber supports, unsettling organic textures"
    ],
    pcOptions: INVESTIGATORS,
    npcs:["Foreman with a crushed hat","Nurse running a tiny clinic","Geology professor on sabbatical","Local preacher who refuses to ring the bell"]
  },
  {
    title:"Mirrors for a Carnival",
    logline:"A travelling fair’s mirror maze shows late arrivals in the reflections. Someone’s collecting the wrong versions.",
    tone:"Gaudy lights; cheerful music detuned; sudden silence.",
    setting:"1925, Rural fairground off a dirt road.",
    acts:[
      {name:"Act I — Tickets at Twilight",beats:["Photographs show extra faces.","A mirror cart is heavier than it should be."]},
      {name:"Act II — The Owner’s Ledger",beats:["Payments to names nobody recognizes.","A cracked mirror whispers in daylight."]},
      {name:"Act III — The Hall of Others",beats:["Reflections lag by minutes.","Something steps out of the wrong pane."]}
    ],
    imagePrompts:[
      "1920s carnival midway at dusk, string lights, painterly",
      "Old ledger and ticket stubs on a wooden desk, moody",
      "Mirror maze interior with warped reflections, eerie"
    ],
    pcOptions: INVESTIGATORS,
    npcs:["Ringmaster with a velvet voice","Fortune-teller who looks past you","Mechanic with mercury stains","Deputy uneasy around mirrors"]
  },
  {
    title:"White Silence",
    logline:"An arctic outpost logs radio messages from a station that never existed. The snow remembers footprints.",
    tone:"White-out isolation; radio hiss; restrained panic.",
    setting:"1928, Arctic research camp.",
    acts:[
      {name:"Act I — The Station on 6.3 MHz",beats:["Morse code contains a plea for help from 'Station K‑Null'.","Maps of the pack ice misalign hours apart."]},
      {name:"Act II — The Memory Snow",beats:["Footprints persist despite wind—until they start walking again.","A missing researcher returns with blank eyes."]},
      {name:"Act III — Below the Drift",beats:["An ice cave hums in a human cadence.","Shut down the transmitter no one brought."]}
    ],
    imagePrompts:[
      "1920s arctic camp, radio mast in snow, painterly",
      "Ice cave with blue light and rope, cinematic",
      "Snowfield with repeating footprints, eerie minimal"
    ],
    pcOptions: INVESTIGATORS,
    npcs:["Radio tech with frostbitten ears","Pilot grounded by weather","Meteorologist who refuses to sleep","Surgeon counting backwards in Russian"]
  }
];

/* ---------- STATE ---------- */
function newScene(name){
  return { id:'scn_'+Math.random().toString(36).slice(2,8), name:name||'Untitled Scene',
    bg:'', tokens:[], fog:makeFog(GRID_W,GRID_H,true), fogUndo:[] };
}
function makeFog(w,h,hidden){ const f=[]; for(let y=0;y<h;y++){const row=[]; for(let x=0;x<w;x++) row.push(!!hidden); f.push(row)} return f; }

const state = {
  settings:{
    openaiKey:'', openaiModel:'gpt-4o-mini', keeperOn:true,
    useImages:false, imageModel:'dall-e-3',
    ttsOn:false, ttsQueue:true, ttsProviderDefault:'browser',
    elevenKey:'', voiceId:'',
    rulesPack:'',
    keeperTrigger:'manual',
    keeperStyle:'normal',
    keeperMax:450,
    voiceMap:{} // { name: {provider:'browser'|'eleven'|'none', id:'VoiceNameOrId'} }
  },
  campaign:null,
  npcCatalog:[],
  youPCId:null,
  sceneIndex:0,
  scenes:[newScene('Intro')],
  chat:[],
  initOrder:[],
  activeTurn:0,
  encounter:{on:false, movesLeft:0, actionsLeft:0},
  browserVoices:[],
  memory:'', // local summary to keep prompts small (no extra tokens)
  aiThinking:false // prevent concurrent AI calls
};
function currentScene(){ return state.scenes[state.sceneIndex]; }

/* ---------- UI HELPERS ---------- */
const byId=id=>document.getElementById(id);
function el(tag,attrs={},children=[]){ const e=document.createElement(tag);
  for(const k in attrs){ if(k==='class') e.className=attrs[k]; else if(k==='html') e.innerHTML=attrs[k]; else if(k==='onclick') e.onclick=attrs[k]; else e.setAttribute(k,attrs[k]); }
  if(!Array.isArray(children)) children=[children];
  children.filter(Boolean).forEach(c=> e.appendChild(typeof c==='string'? document.createTextNode(c): c));
  return e;
}
function toast(msg){ const t=byId('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function stripTags(s){ const d=document.createElement('div'); d.innerHTML=s||''; return d.textContent||d.innerText||''; }
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

/* ---------- PERSISTENCE ---------- */
function saveSettings(){ localStorage.setItem(LS_SETTINGS, JSON.stringify(state.settings)); toast('Settings saved'); }
function loadSettings(){
  const raw=localStorage.getItem(LS_SETTINGS); if(raw){ try{ Object.assign(state.settings, JSON.parse(raw)); }catch{} }
  byId('openaiKey').value = state.settings.openaiKey;
  byId('openaiModel').value = state.settings.openaiModel;
  byId('keeperOn').checked = state.settings.keeperOn;
  byId('useImages').checked = state.settings.useImages;
  byId('imageModel').value = state.settings.imageModel;
  byId('elevenKey').value = state.settings.elevenKey;
  byId('voiceId').value = state.settings.voiceId;
  byId('ttsOn').checked = state.settings.ttsOn;
  byId('ttsQueue').checked = state.settings.ttsQueue;
  byId('ttsProviderDefault').value = state.settings.ttsProviderDefault || 'browser';
  byId('rulesPack').value = state.settings.rulesPack;
  byId('keeperTrigger').value = state.settings.keeperTrigger || 'manual';
  byId('keeperStyle').value = state.settings.keeperStyle || 'normal';
  byId('keeperMax').value = state.settings.keeperMax || 450;
}

/* ---------- MAP RENDER ---------- */
const mapEl=byId('map'), bgEl=byId('mapBg'), fogCv=byId('fog'), reachCv=byId('reach');
function GRID_WPX(){ return mapEl.clientWidth }
function GRID_HPX(){ return mapEl.clientHeight }
function renderAll(){ renderSceneName(); renderBackground(); renderFog(); renderReach(); renderTokens(); renderTokenList(); renderInit(); updateSlots(); updateTurnBanner(); }
function renderSceneName(){ byId('sceneName').textContent=currentScene().name; }
function renderBackground(){ const sc=currentScene(); bgEl.style.backgroundImage=sc.bg?`url(${sc.bg})`:'none'; }
function cellStyle(x,y){ return `left:${((x+0.5)/GRID_W)*100}%; top:${((y+0.5)/GRID_H)*100}%`; }
function initials(n){ return (n||'??').split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join(''); }
function renderTokens(){
  [...mapEl.querySelectorAll('.token')].forEach(n=>n.remove());
  const sc=currentScene();
  const activeToken=getActiveToken();
  sc.tokens.forEach(t=>{
    const n=el('div',{class:`token ${t.type}`,'data-id':t.id, style:cellStyle(t.x,t.y)});
    if(activeToken && activeToken.id===t.id) n.classList.add('active-turn');
    const bubble=el('div',{class:'bubble'});
    if(t.portraitData) bubble.appendChild(el('img',{src:t.portraitData,alt:t.name}));
    else bubble.appendChild(el('div',{class:'letters'}, initials(t.name|| (t.type==='pc'?'PC':'NPC'))));
    n.appendChild(bubble);
    n.appendChild(el('div',{class:'cap'}, t.name|| (t.type==='pc'?'PC':'NPC')));
    mapEl.appendChild(n);
  });
}
function renderTokenList(){
  const list=byId('tokenList'); list.innerHTML='';
  currentScene().tokens.forEach(t=>{
    const row=el('div',{class:'row',style:'justify-content:space-between;margin:.25rem 0;align-items:center;'},
      [el('div',{}, `${t.type.toUpperCase()} • ${t.name||'Unnamed'} @ ${t.x},${t.y}`),
       el('div',{class:'row'},[
         el('button',{class:'ghost',onclick:()=> spawnFXAt(t.x,t.y)},'Ping'),
         el('button',{class:'ghost',onclick:()=> openSheet(t)},'Open Sheet'),
         el('button',{class:'ghost',onclick:()=> editTokenPrompt(t)},'Edit'),
         el('button',{class:'danger',onclick:()=> removeToken(t.id)},'Remove')
       ])]);
    list.appendChild(row);
  });
}

/* ---------- FOG ---------- */
function pxToGrid(px,py){ return [Math.floor((px/GRID_WPX())*GRID_W), Math.floor((py/GRID_HPX())*GRID_H)]; }
function renderFog(){ const cv=fogCv, sc=currentScene(), ctx=cv.getContext('2d'); cv.width=GRID_WPX(); cv.height=GRID_HPX(); ctx.clearRect(0,0,cv.width,cv.height);
  const cw=cv.width/GRID_W, ch=cv.height/GRID_H; ctx.fillStyle='rgba(4,6,10,.82)';
  for(let y=0;y<GRID_H;y++) for(let x=0;x<GRID_W;x++) if(sc.fog[y][x]) ctx.fillRect(Math.floor(x*cw),Math.floor(y*ch),Math.ceil(cw),Math.ceil(ch));
}
function fogStroke(gx,gy,hide){ const sc=currentScene(), before=deepClone(sc.fog), r=Number(byId('brush').value||2);
  for(let y=-r;y<=r;y++) for(let x=-r;x<=r;x++){ const ix=gx+x,iy=gy+y; if(ix<0||iy<0||ix>=GRID_W||iy>=GRID_H) continue; sc.fog[iy][ix]=!!hide; }
  sc.fogUndo.push(before); if(sc.fogUndo.length>50) sc.fogUndo.shift(); renderFog();
}
function fogUndo(){ const sc=currentScene(); const last=sc.fogUndo.pop(); if(last){ sc.fog=last; renderFog(); } }
function fogAll(flag){ const sc=currentScene(); for(let y=0;y<GRID_H;y++) for(let x=0;x<GRID_W;x++) sc.fog[y][x]=!!flag; renderFog(); }

/* ---------- REACHABLE / MOVEMENT ---------- */
const reachCvCtx = reachCv.getContext('2d');
function renderReach(){
  const cv=reachCv, ctx=reachCvCtx; cv.width=GRID_WPX(); cv.height=GRID_HPX(); ctx.clearRect(0,0,cv.width,cv.height);
  if(!state.encounter.on) return;
  const active=getActiveToken(); if(!active) return;
  const cw=cv.width/GRID_W, ch=cv.height/GRID_H;
  ctx.fillStyle='rgba(122,162,255,.18)'; ctx.strokeStyle='rgba(122,162,255,.35)';
  for(let y=0;y<GRID_H;y++) for(let x=0;x<GRID_W;x++){
    const d=chebyshev(active.x,active.y,x,y);
    if(d<=state.encounter.movesLeft){
      ctx.fillRect(Math.floor(x*cw),Math.floor(y*ch),Math.ceil(cw),Math.ceil(ch));
      ctx.strokeRect(Math.floor(x*cw),Math.floor(y*ch),Math.ceil(cw),Math.ceil(ch));
    }
  }
}
function chebyshev(ax,ay,bx,by){ return Math.max(Math.abs(ax-bx),Math.abs(ay-by)); }
function canMoveTo(t,gx,gy,orig){
  if(!state.encounter.on) return {ok:true,to:{x:clamp(gx,0,GRID_W-1),y:clamp(gy,0,GRID_H-1)}};
  // During an encounter, only the player's token can be dragged. AI moves are programmatic.
  if(t.id !== state.youPCId) return {ok:false,to:{x:t.x,y:t.y}};
  const d=chebyshev(orig.x,orig.y,gx,gy); if(d>state.encounter.movesLeft) return {ok:false,to:{x:t.x,y:t.y}};
  return {ok:true,to:{x:clamp(gx,0,GRID_W-1),y:clamp(gy,0,GRID_H-1)}};
}

/* ---------- POINTER TOOLS ---------- */
let tool='select'; let brush=2; let measureEl=null; let pointer={down:false,start:[0,0],cur:[0,0]}, draggingToken=null, dragOrig=null;
mapEl.addEventListener('pointerdown',(e)=>{
  const rect=mapEl.getBoundingClientRect(); pointer.down=true; pointer.start=[e.clientX-rect.left, e.clientY-rect.top]; pointer.cur=pointer.start.slice();
  const [gx,gy]=pxToGrid(pointer.start[0], pointer.start[1]);
  if(tool==='select'){ const t=tokenAt(gx,gy); if(t){ draggingToken=t; dragOrig={x:t.x,y:t.y}; } }
  else if(tool==='ruler'){ startMeasure(pointer.start); }
  else if(tool==='reveal' || tool==='hide'){ fogStroke(gx,gy, tool==='hide'); }
});
mapEl.addEventListener('pointermove',(e)=>{
  if(!pointer.down) return;
  const rect=mapEl.getBoundingClientRect(); pointer.cur=[e.clientX-rect.left, e.clientY-rect.top];
  const [gx,gy]=pxToGrid(pointer.cur[0], pointer.cur[1]);
  if(tool==='select' && draggingToken){ const can=canMoveTo(draggingToken,gx,gy,dragOrig); if(can.ok){ draggingToken.x=can.to.x; draggingToken.y=can.to.y; renderTokens(); renderReach(); } }
  else if(tool==='ruler'){ updateMeasure(pointer.start,pointer.cur); }
  else if(tool==='reveal' || tool==='hide'){ fogStroke(gx,gy, tool==='hide'); }
});
mapEl.addEventListener('pointerup', ()=>{
  pointer.down=false;
  if(draggingToken && state.encounter.on){
    const d=chebyshev(dragOrig.x,dragOrig.y, draggingToken.x, draggingToken.y);
    if(!isActiveToken(draggingToken) || d>state.encounter.movesLeft){ draggingToken.x=dragOrig.x; draggingToken.y=dragOrig.y; renderTokens(); }
    else{ state.encounter.movesLeft -= d; renderReach(); updateTurnBanner(); }
  }
  draggingToken=null; dragOrig=null; endMeasure();
});
window.addEventListener('resize', ()=>{ renderFog(); renderReach(); });

function tokenAt(gx,gy){ return currentScene().tokens.find(t=>t.x===gx && t.y===gy); }
function startMeasure(start){ if(measureEl) measureEl.remove(); measureEl=el('div',{class:'measure'}); measureEl.appendChild(el('div',{class:'label'})); mapEl.appendChild(measureEl); updateMeasure(start,start); }
function updateMeasure(a,b){ if(!measureEl) return; const dx=b[0]-a[0], dy=b[1]-a[1], dist=Math.hypot(dx,dy), ang=Math.atan2(dy,dx)*180/Math.PI; Object.assign(measureEl.style,{left:`${a[0]}px`,top:`${a[1]}px`,width:`${dist}px`,transform:`rotate(${ang}deg)`}); measureEl.querySelector('.label').textContent=`${gridDistance(a,b)} u`; }
function endMeasure(){ if(measureEl){ measureEl.remove(); measureEl=null; } }
function gridDistance(a,b){ const [ax,ay]=pxToGrid(a[0],a[1]), [bx,by]=pxToGrid(b[0],b[1]); return Math.max(Math.abs(ax-bx),Math.abs(ay-by)); }

/* ---------- TOKENS ---------- */
function addToken(t){ const sc=currentScene(); t.id=t.id||('t_'+Math.random().toString(36).slice(2,8)); t.x=clamp(t.x ?? 1,0,GRID_W-1); t.y=clamp(t.y ?? 1,0,GRID_H-1); t.type=t.type||'pc'; t.speed=t.speed ?? 4; t.sheet = t.sheet||defaultSheet(t); sc.tokens.push(t); renderTokens(); renderTokenList(); }
function removeToken(id){ const sc=currentScene(); sc.tokens=sc.tokens.filter(x=>x.id!==id); renderTokens(); renderTokenList(); renderReach(); }
function editTokenPrompt(t){ const name=prompt('Name:', t.name||''); if(name===null) return; const type=prompt('Type (pc|npc):', t.type||'pc'); if(type===null) return; t.name=name.trim(); t.type=(type==='npc')?'npc':'pc'; renderTokens(); renderTokenList(); }

/* ---------- INITIATIVE & TURN MANAGEMENT ---------- */
function isAI(tokenId){
  if(!tokenId) return false;
  return tokenId !== state.youPCId;
}

function rollAllInit(){
  const order = currentScene().tokens.map(t=>({
    id:t.id,
    name:t.name||t.id,
    roll:(Math.floor(Math.random()*20)+1)+(t.sheet?.attrs?.Nerve||0)
  }));
  order.sort((a,b)=>b.roll-a.roll);
  state.initOrder=order;
  state.activeTurn=0;
  renderInit();
  updateTurnBanner();
}

function renderInit(){
  const ol=byId('initList');
  ol.innerHTML='';
  state.initOrder.forEach((e,i)=>{
    const item=el('li',{}, `${state.activeTurn===i?'➡️ ':''}${e.name} — ${e.roll}`);
    if(state.aiThinking && state.activeTurn===i && isAI(e.id)){
      item.appendChild(el('span',{class:'thinking-indicator'}));
    }
    ol.appendChild(item);
  });
  renderTokens();
}

function advanceTurn(){
  if(!state.initOrder.length) return;
  state.activeTurn=(state.activeTurn+1)%state.initOrder.length;
  resetTurnBudget();
  renderInit();
  renderReach();
  updateTurnBanner();
  processTurn();
}

function processTurn(){
  if(!state.encounter.on || state.aiThinking || !state.initOrder.length) return;
  const activeToken=getActiveToken();
  if(!activeToken) return;
  if(isAI(activeToken.id)){
    setTimeout(()=>executeAITurn(activeToken),1500);
  }else{
    toast(`It's your turn, ${activeToken.name}!`);
  }
}

function clearInit(){ state.initOrder=[]; state.activeTurn=0; renderInit(); renderReach(); updateTurnBanner(); }

function startEncounter(){
  if(state.encounter.on){ toast('Encounter already in progress.'); return; }
  state.encounter.on=true;
  if(!state.initOrder.length) rollAllInit();
  resetTurnBudget();
  renderReach();
  updateTurnBanner();
  toast('Encounter started');
  processTurn();
}

function endEncounter(){
  state.encounter.on=false;
  state.aiThinking=false;
  renderReach();
  updateTurnBanner();
  renderInit();
  toast('Encounter ended');
}

function endTurn(){
  if(!state.encounter.on){ toast('Not in encounter'); return; }
  const active=getActiveToken();
  if(active && active.id===state.youPCId){
    advanceTurn();
  }else{
    toast('It is not your turn.');
  }
}

function isActiveToken(t){ const activeEntry=state.initOrder[state.activeTurn]; return activeEntry && t.id===activeEntry.id; }
function getActiveToken(){ const activeEntry=state.initOrder[state.activeTurn]; if(!activeEntry) return null; return currentScene().tokens.find(t=>t.id===activeEntry.id); }

function resetTurnBudget(){
  const t=getActiveToken();
  if(!t) return;
  const mov=t?.sheet?.speed || 8;
  state.encounter.movesLeft=Math.floor(mov/2);
  state.encounter.actionsLeft=1;
}

function updateTurnBanner(){
  if(!state.encounter.on){ byId('turnInfo').textContent='Free exploration'; return; }
  const t=getActiveToken();
  if(!t){ byId('turnInfo').textContent='Encounter (no active)'; return; }
  let turnText=`Turn: ${t.name}`;
  if(isAI(t.id)){
    turnText+= state.aiThinking ? ' (Thinking...)' : ' (AI)';
  }else{
    turnText+=` (You) — Moves: ${state.encounter.movesLeft}, Actions: ${state.encounter.actionsLeft}`;
  }
  byId('turnInfo').textContent=turnText;
}

/* ---------- CHAT & AVATARS ---------- */
const chatLog=byId('chatLog');
byId('cmdInsert').onclick=()=>{
  const v=byId('cmdPicker').value; if(!v) return;
  const input=byId('chatInput'); if(input.value && !/^\s/.test(input.value)) input.value+=' ';
  input.value += v; input.focus();
};
function addLine(text, who='you', opts={}){
  const line = el('div',{class:`line ${who}`});
  const content = el('div',{class:'content'});
  if(who==='you'){ content.textContent=text; } else { content.innerHTML=text; }

  if(who==='keeper'){
    const whoEl = el('div',{class:'who'}, `👁️ ${opts.speaker||'Keeper'}`);
    line.appendChild(whoEl);
    line.appendChild(content);
  }else{
    const youToken=currentScene().tokens.find(t=> t.id===state.youPCId);
    const name=opts.speaker || youToken?.name || 'You';
    const av=el('div',{class:'avatar'});
    av.appendChild(el('img',{src:speakerAvatar(name), alt:name}));
    const whoEl=el('div',{class:'who'}, name);
    line.appendChild(av); line.appendChild(whoEl); line.appendChild(content);
  }

  const controls = el('div',{class:'controls'});
  if((who==='keeper' || opts.replayable) && state.settings.ttsOn){
    const btn=el('button',{class:'ghost',title:'Replay voice',onclick:async()=>{ await speak(stripTags(text), opts.speaker||'Keeper', opts.role || (who==='keeper'?'npc':'pc')); }},'▶');
    controls.appendChild(btn);
  }
  if(controls.childNodes.length) line.appendChild(controls);
  chatLog.appendChild(line); chatLog.scrollTop=chatLog.scrollHeight;
}
function addSay(speaker, text, role='pc'){
  const line=el('div',{class:'line'});
  const av=el('div',{class:'avatar'});
  const img=el('img',{src: speakerAvatar(speaker), alt:speaker});
  av.appendChild(img);
  const whoEl=el('div',{class:'who'}, speaker);
  whoEl.style.color = role==='npc' ? '#e3b9ff' : '#b2ffda';
  const content=el('div',{class:'content'}, text);
  const controls=el('div',{class:'controls'});
  if(state.settings.ttsOn){ controls.appendChild(el('button',{class:'ghost',title:'Replay voice',onclick:()=> speak(stripTags(text), speaker, role)},'▶')); }
  line.appendChild(av); line.appendChild(whoEl); line.appendChild(content); line.appendChild(controls);
  chatLog.appendChild(line); chatLog.scrollTop=chatLog.scrollHeight;
}

function addActionLine(text){
  const line=el('div',{class:'line action'}, text);
  chatLog.appendChild(line);
  chatLog.scrollTop=chatLog.scrollHeight;
}

function addSystemMessage(text){
  const line=el('div',{class:'line system'}, [
    el('div',{class:'who'}, '⚠️ System'),
    el('div',{class:'content', html:text})
  ]);
  chatLog.appendChild(line);
  chatLog.scrollTop=chatLog.scrollHeight;
}
function speakerAvatar(name){
  const t=currentScene().tokens.find(x=> (x.name||'').toLowerCase()===name.toLowerCase());
  if(t?.portraitData) return t.portraitData;
  const np=(state.campaign?.npcPortraits||[]).find(p=> (p.name||p.role||'').toLowerCase()===name.toLowerCase());
  if(np?.portraitData) return np.portraitData;
  const cv=document.createElement('canvas'); cv.width=64; cv.height=64; const ctx=cv.getContext('2d'); ctx.fillStyle='#0e1524'; ctx.fillRect(0,0,64,64);
  ctx.fillStyle='#9fb4ff'; ctx.font='bold 20px ui-monospace,monospace'; const inis=(name||'??').split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join(''); ctx.fillText(inis, 12, 38);
  return cv.toDataURL('image/png');
}

/* ---------- KEEPER & AI HELPERS ---------- */
function buildAIPrompt(actor){
  const sc=currentScene();
  const party=sc.tokens.filter(t=>t.type==='pc').map(t=>`${t.name} at (${t.x},${t.y})`).join('; ');
  const npcs=sc.tokens.filter(t=>t.type==='npc').map(t=>`${t.name} at (${t.x},${t.y})`).join(', ');
  const recentChat = Array.from(chatLog.querySelectorAll('.line')).slice(-5).map(l=>l.innerText).join('\n');

  const persona = `You are ${actor.name}, a ${actor.sheet?.archetype}.
Backstory: ${actor.persona || actor.sheet?.persona}
Traits: ${actor.sheet?.traits || 'As defined by archetype.'}
You remember past events and companions.
Your current health is ${actor.sheet?.hp} HP and ${actor.sheet?.sanity} Sanity.
Your skills of note are: ${Object.entries(actor.sheet.skills).filter(([k,v])=>v>=50).map(([k,v])=>k).join(', ')}.`;

  const instructions = `It's your turn in an encounter. You have ${state.encounter.movesLeft} movement tiles and 1 action.
The scene is: ${sc.name}.
Your allies are: ${party}. NPCs present: ${npcs}.
Story so far: ${state.memory || '(just beginning)'}
Recent events:\n${recentChat}\n
Speak as if you are a player guiding ${actor.name}; use a vivid, in-character voice and refer to allies by name when it makes sense.
Based on your persona and the situation, decide what to do. Your goals are to survive and solve the mystery.
Output ONLY a compact JSON object inside an <engine> tag.
The JSON can have three optional keys: "say" (a string of what you say), "move" (an object with a "to" key like {"to":[x,y]}), and "perform" (a string describing a physical action like "searches the dusty bookshelf").
Example: <engine>{"say": "I'll check over there!", "move": {"to":[${actor.x+1},${actor.y}]}, "perform": "shines their flashlight into the dark corner"}</engine>
Be brief but expressive. Do not narrate. Just provide the JSON for your action.`;

  return [{role:'system',content:persona},{role:'user',content:instructions}];
}

async function executeAITurn(actor){
  if(state.aiThinking) return;
  state.aiThinking=true;
  updateTurnBanner();
  renderInit();

  const messages=buildAIPrompt(actor);
  const model=state.settings.openaiModel||'gpt-4o-mini';
  const key=state.settings.openaiKey;

  try{
    let text;
    if(key && state.settings.keeperOn){
      const res=await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},
        body:JSON.stringify({model, messages, temperature:0.8, max_tokens:200})
      });
      if(!res.ok) throw new Error(await res.text());
      const data=await res.json();
      text=data.choices?.[0]?.message?.content || '{}';
    }else{
      text=`<engine>{"say":"I'm thinking…", "perform":"recalls recent events and scans the room"}</engine>`;
    }

    const eng=parseEngine(text);
    if(eng) await applyEngineResponse(eng, actor);
    maybeSummarizeLocal();

  }catch(err){
    addSystemMessage(`The ether crackles... (${actor.name}'s AI failed).`);
    console.error('AI turn error:', err);
  }finally{
    state.aiThinking=false;
    updateTurnBanner();
    renderInit();
    setTimeout(advanceTurn,2000);
  }
}

async function applyEngineResponse(eng, actor){
  if(eng.perform){
    addActionLine(`* ${actor.name} ${eng.perform} *`);
    await new Promise(r=>setTimeout(r,700));
  }
  if(eng.move && eng.move.to){
    const [gx,gy]=eng.move.to;
    tryMoveCommand(actor, gx, gy, true);
    await new Promise(r=>setTimeout(r,700));
  }
  if(eng.say){
    addSay(actor.name, eng.say, actor.type);
    if(state.settings.ttsOn) speak(stripTags(eng.say), actor.name, actor.type);
  }
}

/* ---------- KEEPER AI (token‑frugal) ---------- */
function keeperSystem(){
  const sc=currentScene();
  const party=sc.tokens.filter(t=>t.type==='pc').map(t=>`${t.name} — persona: ${t.persona||t.sheet?.persona||'N/A'}`).join('; ');
  const npcs=sc.tokens.filter(t=>t.type==='npc').map(t=>t.name).join(', ');
  const you = sc.tokens.find(t=> t.id===state.youPCId);
  const enc = state.encounter.on ? `Encounter ON — ${getActiveToken()?.name||'n/a'} to act, moves ${state.encounter.movesLeft}.` : 'Free exploration';
  const style = state.settings.keeperStyle;
  const brevity = style==='brief' ? 'Use 1–3 sentences.' : (style==='verbose' ? 'Use 4–8 sentences.' : 'Use 2–5 sentences.');
  return `You are The Keeper (tutorial). Teach gently. ${brevity}
- Narrate a beat with personality then give a single clear choice or prompt; keep scenes varied.
- Use generic percentile checks (Success/Hard/Extreme). Avoid proprietary rule text.
- In Encounter mode, prompt the active investigator; ALSO add one short, persona-rich line for a companion and one NPC when present.
- Weave in past events and relationships from the Memory when it helps roleplay.
- Output compact markup + an <engine>{...}</engine> JSON:
  {"say":[{"speaker":string,"role":"pc"|"npc"|"keeper","text":string}...],
   "moves":[{"tokenId":string,"to":[x,y]}...],
   "rollRequests":[{"character":string,"skill":string,"mod":number}...]}

<campaign>
Title: ${state.campaign?.title||'Scenario'}
Acts: ${(state.campaign?.acts||[]).map(a=>a.name).join(' | ')}
Mode: ${enc}
Memory: ${state.memory||'(none)'}
</campaign>

Players (PCs): ${party||'none yet'}
NPCs on scene: ${npcs||'none'}
YOU are: ${you? you.name+' ('+(you.persona||you.sheet?.persona||'no persona')+')' : 'not yet chosen'}
Rules notes: """${state.settings.rulesPack||''}"""
`;
}
function parseEngine(text){ const m=text.match(/<engine>([\s\S]+?)<\/engine>/i); if(!m) return null; try{ return JSON.parse(m[1]); }catch{ return null; } }
function applyEngine(eng){
  if(eng.say){ eng.say.forEach(s=> addSay(s.speaker||'Someone', escapeHtml(s.text||''), s.role||'pc')); }
  if(eng.moves){ eng.moves.forEach(m=>{ const t=currentScene().tokens.find(x=>x.id===m.tokenId); if(t){ tryMoveCommand(t, m.to?.[0], m.to?.[1]); } }); }
  if(eng.rollRequests){ eng.rollRequests.forEach(r=> doRoll('1d100', {who:'keeper', note:`${r.character||'PC'} ${r.skill?`(${r.skill})`:''}`})); }
}
function demoKeeper(userText){
  const tips=[
   "You can move up to 4 tiles on your turn. Try <i>/endturn</i> when done.",
   "Try a careful search. Use <i>/roll 1d100</i> or <i>/check Spot 60</i>.",
   "Consider talking to an NPC; short questions reveal clues."
  ];
  return `A faint draft lifts the dust. ${tips[Math.floor(Math.random()*tips.length)]}
<engine>{"say":[{"speaker":"Local Clerk","role":"npc","text":"First time? Ask if you’re lost—people do."}]}</engine>`;
}
async function keeperReply(userText){
  const sys=keeperSystem(); const msgs=[{role:'system',content:sys},{role:'user',content:userText}];
  const model=state.settings.openaiModel||'gpt-4o-mini'; const key=state.settings.openaiKey;
  const maxTok = Number(state.settings.keeperMax)||450;
  try{
    let text;
    if(key){
      const res=await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},
        body: JSON.stringify({model, messages:msgs, temperature:0.8, max_tokens:maxTok})
      });
      if(!res.ok) throw new Error(await res.text());
      const data=await res.json(); text=data.choices?.[0]?.message?.content || '…';
    }else{ text=demoKeeper(userText); }
    const narr = text.replace(/<engine>[\s\S]*<\/engine>/i,'').trim();
    if(narr) addLine(narr,'keeper',{speaker:'Keeper', role:'npc'});
    const eng=parseEngine(text); if(eng) applyEngine(eng);
    if(state.settings.ttsOn && narr) speak(stripTags(narr),'Keeper','npc');
    maybeSummarizeLocal(); // keep memory fresh without extra tokens
  }catch(err){
    addSystemMessage("The air stills… (AI call failed; offline demo).");
    const demo=demoKeeper(userText); addLine(demo,'keeper',{speaker:'Keeper', role:'npc'}); const eng=parseEngine(demo); if(eng) applyEngine(eng);
  }
}
byId('chatSend').onclick=sendChat;
byId('chatInput').addEventListener('keydown',e=>{ if(e.key==='Enter') sendChat(); });
byId('btnStopVoice').onclick=()=> stopVoice(true);
byId('btnAskKeeper').onclick=()=> askKeeperFromInput();
function askKeeperFromInput(){
  const input=byId('chatInput'); const val=input.value.trim(); if(!val) return;
  keeperReply(val); input.value='';
}
function sendChat(){ const val=byId('chatInput').value.trim(); if(!val) return; byId('chatInput').value=''; addLine(val,'you');
  if(val.startsWith('/')){ runSlash(val); return; }
  if(!state.settings.keeperOn) return;
  if((state.settings.keeperTrigger||'manual')==='auto'){ keeperReply(val); }
}

/* ---------- SLASH ---------- */
function runSlash(val){
  const ck=val.match(/^\/check\s+([A-Za-z][A-Za-z0-9 _-]*)\s+(\d{1,3})$/i);
  if(ck){ const skill=ck[1].trim(); const base=clamp(Number(ck[2]),1,99); const r = rollPercentile(skill, base); addSystemMessage(r.text); return; }

  const kv=val.match(/^\/keeper\s+(.+)/i);
  if(kv){ keeperReply(kv[1]); return; }

  const m=val.match(/^\/roll\s+(.+)$/i); if(m){ doRoll(m[1], {who:'you'}); return; }
  const mv=val.match(/^\/move\s+(.+)\s+to\s+(\d+)\s*,\s*(\d+)$/i);
  if(mv){ const nameOrId=mv[1].trim(); const t=currentScene().tokens.find(x=> x.id===nameOrId || (x.name||'').toLowerCase()===nameOrId.toLowerCase()); if(!t){ addSystemMessage("No such token."); return; } tryMoveCommand(t, Number(mv[2]), Number(mv[3])); return; }
  if(/^\/endturn/i.test(val)){ endTurn(); return; }
  if(/^\/help/i.test(val)){ addSystemMessage("Commands: /roll NdM±K, /check Skill 60, /keeper question, /move [name] to x,y, /endturn."); return; }
  addSystemMessage("Unknown command. Try /help.");
}
function tryMoveCommand(t,gx,gy,isProgrammatic=false){
  const orig={x:t.x,y:t.y};
  const dist=chebyshev(orig.x,orig.y,gx,gy);

  if(state.encounter.on && !isProgrammatic){
    const can=canMoveTo(t,gx,gy,orig);
    if(!can.ok){ addSystemMessage(`Can’t move ${t.name} there right now.`); return; }
    t.x=can.to.x; t.y=can.to.y;
    state.encounter.movesLeft=Math.max(0,state.encounter.movesLeft-dist);
  }else if(state.encounter.on && isProgrammatic){
    if(dist>state.encounter.movesLeft){
      addActionLine(`* ${t.name} tries to move to ${gx},${gy} but lacks the movement. *`);
      return;
    }
    t.x=clamp(gx,0,GRID_W-1); t.y=clamp(gy,0,GRID_H-1);
    state.encounter.movesLeft=Math.max(0,state.encounter.movesLeft-dist);
    addActionLine(`* ${t.name} moves to ${t.x},${t.y}. *`);
  }else{
    t.x=clamp(gx,0,GRID_W-1); t.y=clamp(gy,0,GRID_H-1);
  }

  renderTokens();
  renderReach();
  updateTurnBanner();
  if(!isProgrammatic) spawnFXAt(t.x,t.y);
}

/* ---------- SIMPLE DICE (chat-only) ---------- */
function doRoll(expr, opts={}){ const p=expr.trim().toLowerCase().replace(/^d/,'1d'); const m=p.match(/^(\d+)d(\d+)([+-]\d+)?$/);
  if(!m){ addSystemMessage(`Bad roll: ${expr}`); return; }
  const n=Number(m[1]), sides=Number(m[2]), mod=Number(m[3]||0);
  const rolls=[]; for(let i=0;i<n;i++) rolls.push(1+Math.floor(Math.random()*sides));
  const sum=rolls.reduce((a,b)=>a+b,0)+mod;
  const label = opts.note ? ` (${opts.note})` : '';
  const line = `Roll ${n}d${sides}${mod?(mod>0?`+${mod}`:mod):''}${label} → ${sum} [${rolls.join(', ')}]`;
  addSystemMessage(line);
  return {n,sides,mod,rolls,sum};
}

/* Percentile check with tiers */
function rollPercentile(skillName, skillVal){
  const roll = 1+Math.floor(Math.random()*100);
  const hard = Math.floor(skillVal/2), extreme = Math.max(1,Math.floor(skillVal/5));
  let tier = (roll<=extreme) ? 'Extreme Success' : (roll<=hard) ? 'Hard Success' : (roll<=skillVal) ? 'Success' : 'Failure';
  if(roll===1) tier='Critical Success';
  if(roll===100) tier='Fumble';
  const text = `Check ${skillName} ${skillVal}: d100 → ${roll} → <b>${tier}</b>`;
  return {roll, tier, text};
}

/* ---------- PARTICLES ---------- */
function spawnFXAt(gx,gy){ const box=mapEl.getBoundingClientRect(), cx=(gx+0.5)/GRID_W*box.width, cy=(gy+0.5)/GRID_H*box.height;
  for(let i=0;i<12;i++){ const d=el('div',{class:'fx'}); const ang=Math.random()*2*Math.PI, dist=8+Math.random()*28; const x=cx+Math.cos(ang)*dist,y=cy+Math.sin(ang)*dist;
    Object.assign(d.style,{position:'absolute',left:`${x}px`,top:`${y}px`,width:'4px',height:'4px',background:'#a7c2ff',borderRadius:'50%'}); mapEl.appendChild(d); setTimeout(()=>d.remove(), 400+Math.random()*400); } }

/* ---------- CONTROLS ---------- */
byId('btnSettings').onclick=()=> show('#modalSettings');
byId('btnWizard').onclick  =()=> startWizard(true);
byId('btnScenes').onclick  =()=> { updateSceneList(); show('#modalScenes'); };
byId('btnParty').onclick   =()=> { renderParty(); show('#modalParty'); };
byId('btnNPCs').onclick    =()=> { renderNPCs(); show('#modalNPCs'); };
byId('btnHandouts').onclick=()=> { renderHandouts(); show('#modalHandouts'); };
byId('btnSaveLoad').onclick=()=> { updateSlots(); show('#modalSave'); };

byId('btnSaveSettings').onclick=()=>{
  state.settings.openaiKey=byId('openaiKey').value.trim();
  state.settings.openaiModel=byId('openaiModel').value;
  state.settings.keeperOn=byId('keeperOn').checked;
  state.settings.useImages=byId('useImages').checked;
  state.settings.imageModel=byId('imageModel').value;
  state.settings.elevenKey=byId('elevenKey').value.trim();
  state.settings.voiceId=byId('voiceId').value.trim();
  state.settings.ttsOn=byId('ttsOn').checked;
  state.settings.ttsQueue=byId('ttsQueue').checked;
  state.settings.ttsProviderDefault=byId('ttsProviderDefault').value;
  state.settings.rulesPack=byId('rulesPack').value;
  state.settings.keeperTrigger=byId('keeperTrigger').value;
  state.settings.keeperStyle=byId('keeperStyle').value;
  state.settings.keeperMax=Number(byId('keeperMax').value)||450;
  saveSettings(); hide('#modalSettings');
};

byId('btnRevealAll').onclick=()=> fogAll(false);
byId('btnHideAll').onclick=()=> fogAll(true);
byId('btnUndo').onclick=fogUndo;
byId('btnParticles').onclick=()=> spawnFXAt(Math.floor(GRID_W/2),Math.floor(GRID_H/2));
byId('btnGenBG').onclick=genBGQuick;
byId('btnNewScene').onclick=()=> addScene(prompt('Scene name?','New Scene')||'New Scene');
byId('btnSwitchScene').onclick=()=> { updateSceneList(); show('#modalScenes'); };
byId('btnStartEncounter').onclick=startEncounter;
byId('btnEndTurn').onclick=endTurn;
byId('btnEndEncounter').onclick=endEncounter;
byId('btnCenter').onclick = centerTokens;

function centerTokens(){
  const sc = currentScene();
  const pcs  = sc.tokens.filter(t=>t.type==='pc');
  const npcs = sc.tokens.filter(t=>t.type!=='pc');
  pcs.forEach((t,i)=>{ t.x = Math.round(((i+1)/(pcs.length+1))*(GRID_W-1)); t.y = GRID_H - 1; });
  npcs.forEach((t,i)=>{ t.x = Math.round(((i+1)/(npcs.length+1))*(GRID_W-1)); t.y = 0; });
  renderTokens(); renderReach(); spawnFXAt(Math.floor(GRID_W/2), Math.floor(GRID_H/2)); toast('Tokens centered');
}

/* Scenes modal */
byId('btnSetBG').onclick=()=>{ const d=byId('sceneBgData').value.trim(); if(!d) return; currentScene().bg=d; renderBackground(); toast('Background set'); };
byId('btnGenBG2').onclick=async()=>{ const p=byId('bgPrompt').value.trim()||'moody archive'; await generateBackground(p); };
byId('btnAddScene').onclick=()=> addScene(byId('sceneTitle').value.trim()||'New Scene');
byId('btnSwitchScene2').onclick=()=> { const idx=Number(prompt('Switch to scene index (0..N-1)?', String(state.sceneIndex)))||0; switchScene(idx); hide('#modalScenes'); };
function addScene(name){ state.scenes.push(newScene(name||'New Scene')); updateSceneList(); toast('Scene added'); }
function switchScene(idx){ if(idx<0||idx>=state.scenes.length) return; state.sceneIndex=idx; renderAll(); toast('Switched scene'); }
function updateSceneList(){ const wrap=byId('sceneList'); wrap.innerHTML=''; state.scenes.forEach((s,i)=> wrap.appendChild(el('div',{class:'row',style:'justify-content:space-between;align-items:center;margin:.25rem 0;'},
  [el('div',{class:'meta small'},[el('div',{html:`<b>${escapeHtml(s.name)}</b>`}), el('div',{class:'ts'},[`ID: ${s.id}`])]), el('button',{class:'ghost',onclick:()=> switchScene(i)},'Switch')] ))); }

/* Party modal (+ voice & sheet controls) */
function renderParty(){
  const wrap=byId('partyList'); wrap.innerHTML='';
  currentScene().tokens.filter(t=>t.type==='pc').forEach(t=> wrap.appendChild(pcEditorRow(t)));
}
function pcEditorRow(t){
  const row=el('div',{class:'card',style:'margin:.3rem 0;'});
  row.appendChild(el('div',{html:`<b>${escapeHtml(t.name||'Unnamed')}</b> — ${escapeHtml(t.sheet?.archetype||'Investigator')} @ ${t.x},${t.y}`}));
  const ctrls=el('div',{class:'row',style:'margin-top:.35rem'});
  ctrls.appendChild(el('button',{class:'ghost',onclick:async()=>{ await genPortraitFor(t); renderParty(); }},'Portrait'));
  ctrls.appendChild(el('button',{class:'ghost',onclick:()=> openSheet(t)},'Open Sheet'));
  ctrls.appendChild(el('button',{class:'ghost',onclick:()=>{ const n=prompt('Rename',t.name||''); if(n!==null){ t.name=n; renderTokens(); renderParty(); }}},'Rename'));
  ctrls.appendChild(el('button',{class:'danger',onclick:()=>{ removeToken(t.id); renderParty(); }},'Remove'));
  row.appendChild(ctrls);

  // Voice controls for this PC
  row.appendChild(voiceControlsForName(t.name||'PC'));
  return row;
}
function voiceControlsForName(name){
  const wrap=el('div',{class:'row',style:'margin-top:.35rem;align-items:center;flex-wrap:wrap'});
  wrap.appendChild(el('div',{class:'small'},'Voice:'));
  const provSel=el('select',{}); ['browser','eleven','none'].forEach(p=> provSel.appendChild(el('option',{value:p, selected:(state.settings.voiceMap?.[name]?.provider || state.settings.ttsProviderDefault || 'browser')===p}, p)));
  const voiceSel=el('select',{}); // browser voices
  const voiceInp=el('input',{placeholder:'ElevenLabs Voice ID'}); // eleven
  const testBtn=el('button',{class:'ghost',onclick:()=> speak(`It is I, ${name}.`, name)},'Test');

  // fill browser voices
  const chosenId = state.settings.voiceMap?.[name]?.id || '';
  (state.browserVoices||[]).forEach(v=> voiceSel.appendChild(el('option',{value:v.name, selected: v.name===chosenId}, v.name)));

  function refreshVis(){ voiceSel.style.display = (provSel.value==='browser')?'inline-block':'none'; voiceInp.style.display = (provSel.value==='eleven')?'inline-block':'none'; }
  function updateMap(){
    state.settings.voiceMap[name] = {provider: provSel.value, id: (provSel.value==='browser')? voiceSel.value : (provSel.value==='eleven'? voiceInp.value.trim(): '')};
    saveSettings();
  }
  provSel.onchange=()=>{ refreshVis(); updateMap(); };
  voiceSel.onchange=updateMap;
  voiceInp.oninput=updateMap;

  // initialize inputs
  if(chosenId && provSel.value==='browser'){ voiceSel.value=chosenId; }
  if(state.settings.voiceMap?.[name]?.provider==='eleven'){ voiceInp.value=state.settings.voiceMap?.[name]?.id || ''; }
  refreshVis();

  wrap.appendChild(provSel); wrap.appendChild(voiceSel); wrap.appendChild(voiceInp); wrap.appendChild(testBtn);
  return wrap;
}
byId('btnGenParty').onclick=()=>{ const names=["Eleanor Shaw","Caleb Finch","Iris Caldwell","Thomas Greer","Miriam Kline","Walter Rourke","Opal Reyes","Jonah Pike","Vera Doyle","Silas Hart"]; for(let i=0;i<5;i++){ const n=names[Math.floor(Math.random()*names.length)]; addToken({name:n, type:'pc', x:i, y:GRID_H-1}); } renderParty(); toast('5 investigators added'); };
byId('btnAddPC').onclick=()=>{ addToken({name:prompt('Name?','New Investigator')||'Investigator', type:'pc', x:0, y:GRID_H-1}); renderParty(); };
byId('btnPortraits').onclick=async()=>{ for(const t of currentScene().tokens.filter(t=>t.type==='pc')) await genPortraitFor(t); renderParty(); };

/* NPC modal */
function renderNPCs(){ const wrap=byId('npcList'); wrap.innerHTML=''; currentScene().tokens.filter(t=>t.type==='npc').forEach(t=> wrap.appendChild(npcEditorRow(t))); }
function npcEditorRow(t){ const row=el('div',{class:'row',style:'align-items:center;justify-content:space-between;margin:.25rem 0;flex-wrap:wrap'});
  row.appendChild(el('div',{}, `${t.name||'Unnamed'} @ ${t.x},${t.y}`)); const ctrls=el('div',{class:'row'});
  ctrls.appendChild(el('button',{class:'ghost',onclick:async()=>{ await genPortraitFor(t); renderNPCs(); }},'Portrait'));
  ctrls.appendChild(el('button',{class:'ghost',onclick:()=> openSheet(t)},'Open Sheet'));
  ctrls.appendChild(el('button',{class:'ghost',onclick:()=>{ const n=prompt('Rename',t.name||''); if(n!==null){ t.name=n; renderTokens(); renderNPCs(); }}},'Rename'));
  ctrls.appendChild(el('button',{class:'danger',onclick:()=>{ removeToken(t.id); renderNPCs(); }},'Remove'));
  row.appendChild(ctrls); return row; }
byId('btnGenNPCs').onclick=()=>{ const arche=['Dockhand','Fishmonger','Librarian','Professor','Journalist','Doctor','Officer','Priest','Innkeeper','Smuggler']; for(let i=0;i<4;i++) addToken({name: arche[Math.floor(Math.random()*arche.length)]+' '+(i+1), type:'npc', x:GRID_W-1-i, y:0}); renderNPCs(); };
byId('btnAddNPC').onclick=()=>{ addToken({name:prompt('Name?','Mysterious NPC')||'Mysterious NPC', type:'npc', x:GRID_W-1, y:0}); renderNPCs(); };

/* ---------- HANDOUTS ---------- */
function renderHandouts(){ const list=byId('handoutsList'); list.innerHTML=''; const h=state.campaign?.handouts||[]; if(!h.length){ list.innerHTML='<div class="note">No handouts yet. Click “Generate Handouts”.</div>'; return; }
  h.forEach((ho,i)=>{ const d=el('div',{class:'ho'}); d.appendChild(el('h4',{}, `${ho.title||('Handout '+(i+1))}`)); if(ho.imageUrl) d.appendChild(el('img',{src:ho.imageUrl,alt:ho.title||('handout'+(i+1))})); d.appendChild(el('div',{class:'small'}, ho.text||'')); list.appendChild(d); }); }
byId('btnGenHandouts').onclick=()=> generateHandoutsAuto();

/* ---------- SAVE/LOAD (assets included) ---------- */
function updateSlots(){ const wrap=byId('slots'); wrap.innerHTML=''; const slots=loadSlots(); for(let i=0;i<6;i++){ const slot=slots[i]||null; const row=el('div',{class:'slot'},[
    el('div',{class:'meta'},[ el('div',{}, `Slot ${i+1}: ${slot? (slot.meta?.name||'Campaign'): '— empty —'}`), el('div',{class:'ts'}, slot? new Date(slot.meta?.ts||Date.now()).toLocaleString(): '') ]),
    el('div',{class:'row'},[ el('button',{class:'ghost',onclick:()=> saveToSlot(i)},'Save'), el('button',{class:'warn',onclick:()=> loadFromSlot(i)},'Load'), el('button',{class:'danger',onclick:()=> clearSlot(i)},'Clear') ])
  ]); wrap.appendChild(row);} }
function saveSlots(slots){ localStorage.setItem(LS_SLOTS, JSON.stringify(slots)); }
function loadSlots(){ const raw=localStorage.getItem(LS_SLOTS); return raw? JSON.parse(raw):[]; }
function captureState(){
  return {
    meta:{ts:Date.now(), name: currentScene().name},
    settings: state.settings,
    sceneIndex: state.sceneIndex,
    scenes: state.scenes,
    campaign: state.campaign,
    youPCId: state.youPCId,
    npcCatalog: state.npcCatalog
  };
}
function applyState(data){
  Object.assign(state.settings, data.settings||{});
  state.sceneIndex=data.sceneIndex||0;
  state.scenes=data.scenes||[newScene('Recovered')];
  state.campaign=data.campaign||null;
  state.youPCId=data.youPCId||null;
  state.npcCatalog=data.npcCatalog||[];
  loadSettings(); renderAll();
}
function saveToSlot(i){ const slots=loadSlots(); slots[i]=captureState(); saveSlots(slots); updateSlots(); toast('Saved.'); }
function loadFromSlot(i){ const slots=loadSlots(); if(!slots[i]){ toast('Empty slot'); return; } applyState(slots[i]); toast('Loaded.'); }
function clearSlot(i){ const slots=loadSlots(); slots[i]=null; saveSlots(slots); updateSlots(); }
function saveLocal(){
  localStorage.setItem(LS_QUICK, JSON.stringify(captureState()));
  toast('Saved.');
  hide('#modalSave');
}
function loadLocal(){
  const raw = localStorage.getItem(LS_QUICK);
  if(!raw){ toast('No save'); return; }
  try{ applyState(JSON.parse(raw)); toast('Loaded.'); hide('#modalSave'); }
  catch{ toast('Bad save'); }
}
byId('btnExport').onclick=()=>{ const blob=new Blob([JSON.stringify(captureState(),null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='solo-investigator-save.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 2000); };
byId('btnImport').onclick=()=>{ try{ const data=JSON.parse(byId('importText').value.trim()); applyState(data); toast('Imported.'); }catch{ toast('Bad JSON'); } };
byId('btnSave').onclick=saveLocal;
byId('btnLoad').onclick=loadLocal;

/* ---------- IMAGES (Data URLs; cached) ---------- */
async function openaiImage(prompt, size='1024x1024'){
  // Return a data URL so saves keep assets; cache by prompt+model+size
  const key=state.settings.openaiKey; const use=state.settings.useImages && state.settings.imageModel!=='placeholders';
  const model=state.settings.imageModel || 'dall-e-3';
  const cacheKey = await hashKey(`img|${model}|${size}|${prompt}`);
  const cached=await idbGet('images',cacheKey); if(cached) return cached;

  if(!key || !use){
    const ph = await placeholderImage(prompt,size); await idbSet('images',cacheKey,ph); return ph;
  }
  try{
    const res=await fetch('https://api.openai.com/v1/images/generations',{ method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`}, body: JSON.stringify({model, prompt, size, response_format:'b64_json'}) });
    if(!res.ok){
      // gracefully fallback without spamming tokens next time
      const ph = await placeholderImage(prompt,size); await idbSet('images',cacheKey,ph);
      return ph;
    }
    const data=await res.json(); const b64=data.data?.[0]?.b64_json; if(!b64){ const ph=await placeholderImage(prompt,size); await idbSet('images',cacheKey,ph); return ph; }
    const dataUrl = `data:image/png;base64,${b64}`; await idbSet('images',cacheKey,dataUrl); return dataUrl;
  }catch(e){
    const ph=await placeholderImage(prompt,size); await idbSet('images',cacheKey,ph); return ph;
  }
}
async function placeholderImage(prompt,size='1024x1024'){ const [w,h]=size.split('x').map(Number); const cv=document.createElement('canvas'); cv.width=w; cv.height=h; const ctx=cv.getContext('2d');
  const g=ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#0d1524'); g.addColorStop(1,'#09101c'); ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
  ctx.globalAlpha=.1; for(let i=0;i<42;i++){ ctx.fillStyle='#7aa2ff'; const r=20+Math.random()*120; ctx.beginPath(); ctx.arc(Math.random()*w,Math.random()*h,r,0,Math.PI*2); ctx.fill(); } ctx.globalAlpha=1;
  ctx.fillStyle='#cfe1ff'; ctx.font='bold '+Math.floor(w*0.04)+'px ui-monospace,monospace'; ctx.fillText('SCENE',24,56); ctx.font=''+Math.floor(w*0.025)+'px ui-monospace,monospace'; ctx.fillText((prompt||'Moody scene').slice(0,64),24,90); return cv.toDataURL('image/png'); }
async function genBGQuick(){ await generateBackground('Gloomy archive, dramatic slant light, painterly, film grain'); }
async function generateBackground(prompt){ try{ const dataUrl=await openaiImage(prompt,'1024x1024'); currentScene().bg=dataUrl; renderBackground(); toast('Background ready'); }catch(e){ toast('Image error'); } }

/* ---------- TTS (Browser + ElevenLabs) ---------- */
let ttsQueue=[], ttsPlaying=false, currentAudio=null, currentUrl=null;
function providerFor(speaker, role='pc'){ const key=(role==='npc' || speaker==='Keeper')?'npc':speaker; const m=state.settings.voiceMap?.[key]; return m?.provider || state.settings.ttsProviderDefault || 'browser'; }
function voiceIdFor(speaker, role='pc'){ const key=(role==='npc' || speaker==='Keeper')?'npc':speaker; const m=state.settings.voiceMap?.[key]; return m?.id || (providerFor(speaker, role)==='eleven'? state.settings.voiceId : ''); }

async function speak(text, speaker='Keeper', role='pc'){
  if(!state.settings.ttsOn || !text) return;
  const provider=providerFor(speaker, role);
  if(provider==='eleven' && state.settings.elevenKey){ const {blob}=await getOrCreateTTS(text, speaker, role); if(state.settings.ttsQueue) enqueueTTS(blob); else playBlobImmediate(blob); }
  else if(provider==='browser'){ speakBrowser(text, speaker, role); }
}
async function getOrCreateTTS(text, speaker, role='pc'){
  const key = await hashKey(`tts|eleven|${voiceIdFor(speaker, role)}|${speaker}|${(text||'').trim()}`);
  const hit=await idbGet('tts',key); if(hit){ return {blob:hit,key}; }
  const blob=await fetchTTSBlob(text, voiceIdFor(speaker, role)); await idbSet('tts',key,blob); return {blob,key};
}
function speakBrowser(text, speaker, role='pc'){ try{ window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text); const id=voiceIdFor(speaker, role); const v=state.browserVoices.find(v=> v.name===id) || state.browserVoices[0]; if(v) u.voice=v; window.speechSynthesis.speak(u); }catch{} }
function stopVoice(clearQueue){ try{ if(currentAudio){ currentAudio.pause(); } if(currentUrl){ URL.revokeObjectURL(currentUrl); currentUrl=null; } currentAudio=null; window.speechSynthesis.cancel(); }catch{} if(clearQueue){ ttsQueue.length=0; ttsPlaying=false; } }

/* Browser voices list */
function refreshBrowserVoices(){ state.browserVoices = window.speechSynthesis.getVoices()||[]; }
if('speechSynthesis' in window){ window.speechSynthesis.onvoiceschanged = refreshBrowserVoices; refreshBrowserVoices(); }

/* IndexedDB (images as DataURL strings; tts as Blobs) */
const dbp=new Promise((resolve,reject)=>{ const open=indexedDB.open('si_cache_v3',1); open.onupgradeneeded=(e)=>{ const db=e.target.result; if(!db.objectStoreNames.contains('tts')) db.createObjectStore('tts'); if(!db.objectStoreNames.contains('images')) db.createObjectStore('images'); }; open.onsuccess=()=>resolve(open.result); open.onerror=()=>reject(open.error); });
function idbGet(store,key){ return dbp.then(db=> new Promise((res,rej)=>{ const tx=db.transaction(store,'readonly'); const r=tx.objectStore(store).get(key); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error);})); }
function idbSet(store,key,val){ return dbp.then(db=> new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); const r=tx.objectStore(store).put(val,key); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error);})); }
async function hashKey(s){ const buf=new TextEncoder().encode(s); const hash=await crypto.subtle.digest('SHA-256',buf); return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join(''); }

/* ---------- WIZARD ---------- */
const wizard={step:0, arc:null, youIndex:null, companions:[], rolls:{}, variety:{ era:'1920s', locale:'Inland city', theme:'Investigative', avoidCoast:true, seed:Math.floor(Math.random()*1e9)}};
byId('btnWizardNext').onclick=()=> wizardNext();
byId('btnWizardBack').onclick=()=> wizardBack();
function startWizard(force=false){ if(!force && localStorage.getItem(LS_WIZARD)) return; wizard.step=0; wizard.arc=null; wizard.youIndex=null; wizard.companions=[]; wizard.rolls={}; renderWizard(); show('#modalWizard'); }
function setStepPills(){ for(let i=0;i<5;i++){ const elB=byId('wStep'+i+'B'); if(elB) elB.classList.toggle('active', i===wizard.step); } }
function renderWizard(){
  setStepPills(); const body=byId('wizardBody'); body.innerHTML='';
  if(wizard.step===0){
    body.appendChild(el('div',{class:'grid2'},[
      el('div',{class:'card'},[
        el('h3',{},'1) Paste your keys (optional)'), el('div',{class:'small'},'OpenAI enables AI Keeper + images. ElevenLabs enables premium voices. Browser voices are free and default.'),
        el('div',{class:'hr'}), el('label',{},'OpenAI API Key'), el('input',{id:'w_openai',value:state.settings.openaiKey||'',placeholder:'sk-...'}),
        el('label',{},'ElevenLabs API Key'), el('input',{id:'w_eleven',value:state.settings.elevenKey||'',placeholder:'eleven-...'}),
        el('label',{},'ElevenLabs Default Voice ID'), el('input',{id:'w_voice',value:state.settings.voiceId||'',placeholder:'21m00Tcm4TlvDq8ikWAM'}),
        el('div',{class:'row'},[
          el('label',{},[el('input',{type:'checkbox',id:'w_useimg',checked:state.settings.useImages}), ' Enable Images']),
          el('label',{},'Image Model'),
          (function(){ const s=el('select',{id:'w_imgmodel'}); ['dall-e-3','gpt-image-1','placeholders'].forEach(m=> s.appendChild(el('option',{value:m, selected:state.settings.imageModel===m}, m))); return s; })(),
          el('label',{},'TTS Default'),
          (function(){ const s=el('select',{id:'w_ttsdef'}); ['browser','eleven','none'].forEach(m=> s.appendChild(el('option',{value:m, selected:(state.settings.ttsProviderDefault||'browser')===m}, m))); return s; })(),
          el('label',{},[el('input',{type:'checkbox',id:'w_tts',checked:state.settings.ttsOn}), ' Enable Voices']),
          el('label',{},[el('input',{type:'checkbox',id:'w_queue',checked:true}), ' Queue voice'])
        ])
      ]),
      el('div',{class:'card'},[
        el('h3',{},'What you’ll learn'), el('div',{class:'small'},
         'Movement, measuring, fog, basic checks, initiative and turns. The Keeper nudges you. Companions speak in-character with their own voices.')
      ])
    ]));
    byId('btnWizardBack').disabled=true;
  }
  if(wizard.step===1){
    const varietyUI = el('div',{class:'card'},[
      el('h3',{},'2) Variety Pack'),
      el('div',{class:'grid3'},[
        (function(){ const c=el('div',{class:'col'}); c.appendChild(el('label',{},'Era')); const s=el('select',{id:'v_era'}); ['1890s Gaslight','1920s','1950s','1970s','Modern'].forEach(v=> s.appendChild(el('option',{value:v, selected:wizard.variety.era===v}, v))); c.appendChild(s); return c; })(),
        (function(){ const c=el('div',{class:'col'}); c.appendChild(el('label',{},'Locale')); const s=el('select',{id:'v_locale'}); ['Inland city','Rural farmland','Desert frontier','Arctic outpost','Mountain mining town','University campus','Hospital complex','Museum & archives','Jungle expedition','Coastal port'].forEach(v=> s.appendChild(el('option',{value:v, selected:wizard.variety.locale===v}, v))); c.appendChild(s); return c; })(),
        (function(){ const c=el('div',{class:'col'}); c.appendChild(el('label',{},'Theme')); const s=el('select',{id:'v_theme'}); ['Investigative','Psychological','Folkloric','Scientific horror','Heist-gone-wrong'].forEach(v=> s.appendChild(el('option',{value:v, selected:wizard.variety.theme===v}, v))); c.appendChild(s); return c; })()
      ]),
      el('label',{},[el('input',{type:'checkbox',id:'v_avoid',checked:wizard.variety.avoidCoast}), ' Avoid coastal openings unless I choose “Coastal port”']),
      el('div',{class:'row',style:'margin-top:.35rem;'},[
        el('label',{},'Randomness Seed (optional)'),
        el('input',{id:'v_seed',placeholder:String(wizard.variety.seed),value:String(wizard.variety.seed)})
      ])
    ]);
    const arcUI = el('div',{class:'card'},[
      el('h3',{},'Generate a story arc'),
      el('div',{class:'row'},[
        el('button',{class:'primary',onclick:()=> genStoryArcAI(true)},'Generate with AI'),
        el('button',{class:'ghost',onclick:()=>{ pickDemoArc(); renderWizard(); toast('Demo arc loaded'); }},'Use Random Demo Arc')
      ]),
      el('div',{id:'arcStatus',class:'note',style:'margin-top:.5rem'}, wizard.arc? `Loaded: ${wizard.arc.title}` : 'No arc generated yet.')
    ]);
    const prev = el('div',{class:'card'},[ el('h3',{},'Arc preview'), el('div',{id:'arcPreview',class:'small'}, wizard.arc? arcHtml(wizard.arc): 'Generate or select an arc to preview.') ]);
    body.appendChild(el('div',{class:'grid2'},[varietyUI, arcUI])); body.appendChild(prev);
    byId('btnWizardBack').disabled=false;
  }
  if(wizard.step===2){
    const arc=wizard.arc||pickDemoArc();
    const list=el('div',{}, arc.pcOptions.map((opt,idx)=> invOption(opt,idx)));
    const voiceSetup=el('div',{class:'card'},[
      el('h3',{},'Voice Setup (optional, per speaker)'),
      el('div',{class:'small'},'Pick Browser voices (free) or enter ElevenLabs IDs per character.'),
      el('div',{id:'voiceSetupRows'})
    ]);
    body.appendChild(el('div',{class:'card'},[
      el('h3',{},'3) Choose YOU + 4 companions'),
      el('div',{class:'small'},'Click “Me” on one investigator, then “Add Companion” on exactly four others. Click “Roll Stats” to set starting attributes.'),
      el('div',{class:'hr'}), list, el('div',{class:'small',id:'partyPickInfo',style:'margin-top:.5rem;color:#bcd1ff'}, pickSummary())
    ]));
    body.appendChild(voiceSetup);
    renderVoiceSetup();
  }
  if(wizard.step===3){
    body.appendChild(el('div',{class:'grid2'},[
      el('div',{class:'card'},[
        el('h3',{},'4) Auto‑build your game (with progress)'),
        el('div',{class:'small'},'Creates scenes per act, backgrounds (or placeholders), spawns your chosen party + NPCs, portraits, handouts, and an NPC portrait catalog.'),
        el('div',{class:'row'},[ el('button',{class:'primary',onclick:()=> wizardAutoBuildEverything()},'Build Everything Now') ]),
        el('div',{id:'buildStatus',class:'note',style:'margin-top:.5rem'}, 'Not built yet.')
      ]),
      el('div',{class:'card'},[
        el('h3',{},'Tips'),
        el('div',{class:'small'},'Encounter mode: Start Encounter → move up to 4 tiles → one action → /endturn. Use /check Skill 60 for generic checks.')
      ])
    ]));
  }
  if(wizard.step===4){
    body.appendChild(el('div',{class:'card'},[
      el('h3',{},'5) You’re ready'),
      el('div',{class:'small'},'The Keeper will introduce the scene and guide you. Click "Begin Play" or Next to start.'),
      el('div',{class:'row'},[ el('button',{class:'primary',onclick:()=>{ localStorage.setItem(LS_WIZARD,'1'); hide('#modalWizard'); greetAndStart(); }},'Begin Play') ])
    ]));
  }
}
function wizardBack(){ if(wizard.step>0){ wizard.step--; renderWizard(); } }
async function wizardNext(){
  if(wizard.step===0){
    state.settings.openaiKey = byId('w_openai').value.trim();
    state.settings.elevenKey = byId('w_eleven').value.trim();
    state.settings.voiceId   = byId('w_voice').value.trim();
    state.settings.useImages = byId('w_useimg').checked;
    state.settings.imageModel= (byId('w_imgmodel').value||'dall-e-3');
    state.settings.ttsProviderDefault = byId('w_ttsdef').value;
    state.settings.ttsOn     = byId('w_tts').checked;
    state.settings.ttsQueue  = byId('w_queue').checked;
    saveSettings();
  }
  if(wizard.step===1){
    wizard.variety.era    = byId('v_era').value;
    wizard.variety.locale = byId('v_locale').value;
    wizard.variety.theme  = byId('v_theme').value;
    wizard.variety.avoidCoast = byId('v_avoid').checked;
    const seedVal = parseInt(byId('v_seed').value,10); if(!isNaN(seedVal)) wizard.variety.seed=seedVal;
    if(!wizard.arc){ if(state.settings.openaiKey){ await genStoryArcAI(true); } else { pickDemoArc(); } }
  }
  if(wizard.step===2){ if(wizard.youIndex==null || wizard.companions.length!==4){ toast('Pick yourself and exactly 4 companions.'); return; } }
  if(wizard.step===3){
    const txt=byId('buildStatus')?.textContent||''; if(!/ready/i.test(txt)){ await wizardAutoBuildEverything(); }
  }
  if(wizard.step<4){ wizard.step++; renderWizard(); } else { localStorage.setItem(LS_WIZARD,'1'); hide('#modalWizard'); greetAndStart(); }
}
function arcHtml(arc){ return `<b>${escapeHtml(arc.title)}</b><br>${escapeHtml(arc.logline)}<br><br>${arc.acts.map(a=>`<span class="tag">${escapeHtml(a.name)}</span>`).join(' ')}` }
function invOption(opt, idx){
  const wrap=el('div',{class:'card',id:`inv_${idx}`,style:'margin:.4rem 0'});
  if(wizard.youIndex===idx) wrap.classList.add('meSel'); if(wizard.companions.includes(idx)) wrap.classList.add('compSel');
  wrap.appendChild(el('div',{html:`<b>${escapeHtml(opt.name)}</b> — ${escapeHtml(opt.archetype)}<br><span class="small">${escapeHtml(opt.backstory)} <i>(${escapeHtml(opt.traits)})</i></span>`}));
  const row=el('div',{class:'row',style:'margin-top:.25rem'});
  row.appendChild(el('button',{class:'ghost',onclick:()=> rollStats(idx)},'Roll Stats'));
  row.appendChild(el('button',{class:'primary',onclick:()=> chooseMe(idx)}, wizard.youIndex===idx?'Chosen (Me)':'Choose Me'));
  row.appendChild(el('button',{class:'ghost',onclick:()=> toggleCompanion(idx)}, wizard.companions.includes(idx)?'Remove Companion':'Add Companion'));
  wrap.appendChild(row);
  const rolled=wizard.rolls[idx]; wrap.appendChild(el('div',{id:`rolled_${idx}`,class:'small',style:'margin-top:.25rem;color:#bcd1ff'}, rolled? fmtStats(rolled):''));
  return wrap;
}
function fmtStats(st){ return `Rolled: ${Object.entries(st).map(([k,v])=>`${k} ${v}`).join(' · ')}`; }
function pickSummary(){
  const opts = wizard.arc?.pcOptions || INVESTIGATORS;
  return `You: ${wizard.youIndex!=null? opts[wizard.youIndex].name:'—'} · Companions (${wizard.companions.length}/4)`;
}
function rollStats(idx){ const stats={Brains: roll3d6plus(3), Brawn: roll3d6plus(3), Nerve: roll3d6plus(3), Perception: roll3d6plus(3), Charm: roll3d6plus(3)}; wizard.rolls[idx]=stats; const elr=byId('rolled_'+idx); if(elr) elr.textContent=fmtStats(stats); }
function roll3d6plus(a){ let s=0; for(let i=0;i<3;i++) s+=1+Math.floor(Math.random()*6); return s+a; }
function chooseMe(idx){
  const opts = wizard.arc?.pcOptions || INVESTIGATORS;
  wizard.youIndex=idx;
  toast('Selected '+opts[idx].name);
  renderWizard();
}
function toggleCompanion(idx){ if(wizard.youIndex===idx){ toast('That is YOU.'); return; } const i=wizard.companions.indexOf(idx); if(i>=0) wizard.companions.splice(i,1); else { if(wizard.companions.length>=4){ toast('Already 4 companions.'); return; } wizard.companions.push(idx); } renderWizard(); }

/* Voice setup in wizard */
function renderVoiceSetup(){
  const wrap=byId('voiceSetupRows'); if(!wrap) return; wrap.innerHTML='';
  const opts = wizard.arc?.pcOptions || INVESTIGATORS;
  const names = [];
  if(wizard.youIndex!=null) names.push(opts[wizard.youIndex].name);
  wizard.companions.forEach(i=> names.push(opts[i].name));
  names.unshift('Keeper');
  names.forEach(n=>{
    wrap.appendChild(voiceControlsForName(n));
  });
}

/* ---------- STORY ARC (AI) with variety & anti-repetition ---------- */
function pickDemoArc(){
  const v = wizard.variety;
  let pool = DEMO_ARCS.slice();
  if(v.locale.includes('University')||v.locale.includes('Museum')) pool = DEMO_ARCS.filter(a=> /library|archives|museum/i.test(a.setting));
  else if(v.locale.includes('Mountain')) pool = DEMO_ARCS.filter(a=> /Mountain/i.test(a.setting));
  else if(v.locale.includes('Arctic')) pool = DEMO_ARCS.filter(a=> /Arctic/i.test(a.setting));
  else if(v.locale.includes('Rural')) pool = DEMO_ARCS.filter(a=> /Rural|fair/i.test(a.setting));
  if(!pool.length) pool = DEMO_ARCS.slice();
  const arc = deepClone(pool[Math.floor(Math.random()*pool.length)]);
  wizard.arc=arc; state.campaign=arc; const prev=byId('arcPreview'); if(prev) prev.innerHTML=arcHtml(arc);
  return arc;
}
async function genStoryArcAI(retryOnSimilar=false){
  const key=state.settings.openaiKey; const status=byId('arcStatus'); if(!key){ toast('OpenAI key required'); return; }
  if(status) status.textContent='Generating arc…';
  const v=wizard.variety;
  const diversityId = Math.random().toString(36).slice(2,10)+'-'+v.seed;
  const ingredientsPacks = [
    {locales:["rail depot","hydroelectric dam","sanitarium","opera house","desert dig site","orphanage","subway tunnels","clock factory"], motifs:["echoes","paper monsters","misnumbered doors","stolen faces","timekeeping errors"], threats:["administrator","archivist collective","sleepwalkers","signalman"], ban:["coast","docks","cannery","fog horn"]},
    {locales:["planetarium","radio tower","ice rink","observatory dome","mountain hotel","seance parlor","ship graveyard (avoid unless coastal chosen)","salt flats"], motifs:["wrong shadows","repeating names","letters that bruise skin","bloodless blood"], threats:["radio host","surgeon","antiquarian ring","chorus"], ban:["sailors","harbor","tide","wharf"]}
  ];
  const ing = ingredientsPacks[Math.floor(Math.random()*ingredientsPacks.length)];
  const creative = `Ingredients: pick 2–3 from locales ${ing.locales.join(', ')}, motifs ${ing.motifs.join(', ')}, threats ${ing.threats.join(', ')}. Ban motifs: ${ing.ban.join(', ')}.`;

  const sys=`You are a scenario designer. Return ONLY compact JSON with keys:
{ "title": string, "logline": string, "tone": string, "setting": string,
  "acts": [{ "name": string, "beats": string[] } ... exactly 3],
  "imagePrompts": string[] (3 painterly prompts),
  "pcOptions": [{ "archetype": string, "name": string, "backstory": string, "traits": string, "prompt": string } ... 10],
  "npcs": string[] (>=6 varied roles)
}
Constraints:
- Era: ${v.era}. Locale: ${v.locale}. Theme: ${v.theme}.
- ${v.avoidCoast && v.locale!=='Coastal port' ? 'Do NOT use coastal imagery.' : 'Coastal allowed.'}
- Avoid prior common tropes: docks, cannery, “Chapel Below,” seawater rites (unless Coastal explicitly picked).
- Diversity ID: ${diversityId}. Use it indirectly to vary topics, names, and imagery.
- ${creative}
- Keep it tutorial-friendly: clear investigative beats, not combat-driven.`;

  let tries=0, arc=null;
  const recent = JSON.parse(localStorage.getItem(LS_ARC_FP)||'[]').slice(-3);
  while(tries<2){
    tries++;
    try{
      const res=await fetch('https://api.openai.com/v1/chat/completions',{ method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},
        body: JSON.stringify({model: state.settings.openaiModel||'gpt-4o-mini', temperature:0.95, messages:[{role:'system',content:sys},{role:'user',content:'Create a fresh 3‑act arc with unique flavor.'}]})
      });
      if(!res.ok) throw new Error(await res.text());
      const data=await res.json(); const txt=data.choices?.[0]?.message?.content||'{}'; arc=JSON.parse(txt);
    }catch(e){ arc=null; }
    if(!arc){ continue; }
    const fp = arcFingerprint(arc);
    if(retryOnSimilar && recent.includes(fp)){ arc=null; continue; }
    recent.push(fp); localStorage.setItem(LS_ARC_FP, JSON.stringify(recent.slice(-6)));
    wizard.arc=arc; state.campaign=arc; const prev=byId('arcPreview'); if(prev) prev.innerHTML=arcHtml(arc); if(status) status.textContent='Arc generated.'; return;
  }
  const d=pickDemoArc(); if(status) status.textContent='Fell back to demo arc.';
}
function arcFingerprint(arc){
  const s=(arc.title||'')+'|'+(arc.setting||'')+'|'+(arc.acts||[]).map(a=>a.name).join(',');
  return s.toLowerCase().replace(/[^a-z0-9|,]+/g,'').slice(0,200);
}

/* ---------- AUTO BUILD with PROGRESS ---------- */
const PROG_STEPS = ["Create Scenes","Backgrounds","Spawn PCs","Spawn NPCs","Portraits (PCs)","Portraits (NPCs)","Handouts","NPC Catalog"];
function progressOpen(title="Building…"){ byId('progTitle').textContent=title; const list=byId('progSteps'); list.innerHTML=''; PROG_STEPS.forEach((s,i)=> list.appendChild(el('div',{class:'stepItem',id:'step_'+i},[el('div',{class:'dot'}), el('div',{}, s)]))); byId('progBar').style.width='0%'; show('#modalProgress'); }
function progressSet(i){ const pct=Math.round(((i+1)/PROG_STEPS.length)*100); byId('progBar').style.width=pct+'%'; for(let k=0;k<PROG_STEPS.length;k++){ const n=byId('step_'+k); n.classList.toggle('done', k<i); n.classList.toggle('cur', k===i); } }
function progressClose(){ hide('#modalProgress'); }
async function wizardAutoBuildEverything(){
  const arc=wizard.arc||pickDemoArc();
  const status=byId('buildStatus');
  if(status) status.textContent='Building…';
  state.campaign = arc;
  progressOpen("Assembling your table");
  try{
    // 0: Scenes
    progressSet(0);
    state.scenes=[]; arc.acts.forEach(a=> state.scenes.push(newScene(a.name))); state.sceneIndex=0;
    // 1: Backgrounds
    progressSet(1);
    for(let i=0;i<state.scenes.length;i++){ const prompt=(arc.imagePrompts&&arc.imagePrompts[i])||arc.imagePrompts?.[0]||`${arc.setting} — ${arc.acts[i].name}`; try{ const dataUrl=await openaiImage(prompt,'1024x1024'); state.scenes[i].bg=dataUrl; }catch{} }
    renderBackground();
    // 2: PCs
    progressSet(2);
    const opts = arc.pcOptions || INVESTIGATORS;
    const picks=[wizard.youIndex, ...wizard.companions].map(i=> opts[i]);
    currentScene().tokens.length=0;
    picks.forEach((p,i)=> addToken({name:p.name, type:'pc', x:i, y:GRID_H-1, persona:`${p.archetype}. Backstory: ${p.backstory}. Traits: ${p.traits}.`, speed:4}));
    const youName=opts[wizard.youIndex].name;
    const youToken=currentScene().tokens.find(t=>t.name===youName && t.type==='pc');
    if(youToken){
      state.youPCId=youToken.id;
      toast(`You will play as ${youToken.name}.`);
    }else{
      console.error('Could not assign player character!');
      const firstPC=currentScene().tokens.find(t=>t.type==='pc');
      if(firstPC) state.youPCId=firstPC.id;
    }
    // 3: NPCs
    progressSet(3);
    (arc.npcs||[]).slice(0,4).forEach((n,i)=> addToken({name:n, type:'npc', x:GRID_W-1-i, y:0, persona:"NPC with local knowledge"}));
    // 4: Portraits PCs
    progressSet(4);
    for(const t of currentScene().tokens.filter(t=>t.type==='pc')) await genPortraitFor(t);
    // 5: Portraits NPCs
    progressSet(5);
    for(const t of currentScene().tokens.filter(t=>t.type==='npc')) await genPortraitFor(t);
    // 6: Handouts
    progressSet(6);
    await generateHandoutsAuto(arc);
    // 7: NPC Catalog
    progressSet(7);
    await ensureNPCCatalog(arc);
    renderAll(); if(status) status.textContent='Ready.'; toast('Build complete.');
  }catch(e){ if(status) status.textContent='Build failed'; }
  finally{ setTimeout(progressClose, 400); }
}

/* NPC Catalog (prepare portraits for later) */
async function ensureNPCCatalog(arc){
  let catalog=[];
  if(state.settings.openaiKey){
    try{
      const sys=`Return JSON {"npcs":[{"role":string,"name":string,"prompt":string}... 8 items]}
Roles should match the scenario (${arc.title}) across varied professions (authority, scholar, worker, occult, medical, criminal, clergy, bystander).
Prompts should describe a 1920s portrait in cinematic, painterly style. Return ONLY JSON.`;
      const res=await fetch('https://api.openai.com/v1/chat/completions',{ method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.settings.openaiKey}`},
        body: JSON.stringify({model: state.settings.openaiModel||'gpt-4o-mini', temperature:0.6, max_tokens:350, messages:[{role:'system',content:sys},{role:'user',content:`Scenario summary: ${arc.logline}. Setting: ${arc.setting}.`}]})
      });
      if(res.ok){ const data=await res.json(); const txt=data.choices?.[0]?.message?.content||'{}'; const out=JSON.parse(txt); catalog=out.npcs||[]; }
    }catch{ /* ignore */ }
  }
  if(!catalog.length){
    catalog = [
      {role:'Sheriff', name:'Sheriff Ada Colton', prompt:'1920s sheriff portrait, wool uniform, side cap, stern gaze'},
      {role:'Librarian', name:'Martha Kincaid', prompt:'1920s librarian portrait, card catalog backdrop'},
      {role:'Dock Foreman', name:'Briggs Malloy', prompt:'1920s dock foreman, flat cap, oilskin coat'},
      {role:'Clergyman', name:'Reverend Hale', prompt:'1920s pastor portrait, candlelit vestry'},
      {role:'Doctor', name:'Dr. Samuel Pike', prompt:'1920s doctor portrait, hospital corridor'},
      {role:'Antiquarian', name:'Elias Greaves', prompt:'1920s antiquarian, dusty shop, ledgers'},
      {role:'Officer', name:'Constable Reed', prompt:'1920s police officer, lantern, drizzle'},
      {role:'Cult Acolyte', name:'“Initiate”', prompt:'hooded figure, half‑lit, ritual threads'}
    ];
  }
  state.campaign = state.campaign || {}; state.campaign.npcPortraits = [];
  for(const npc of catalog){
    let dataUrl; try{ dataUrl = await openaiImage(`${npc.prompt}, chiaroscuro, painterly, round crop`, '1024x1024'); }catch{ dataUrl = await placeholderImage(npc.prompt, '512x512'); }
    state.campaign.npcPortraits.push({role:npc.role, name:npc.name, prompt:npc.prompt, portraitData:dataUrl});
  }
}

/* ---------- HANDOUTS ---------- */
async function generateHandoutsAuto(arc=state.campaign){
  let handouts=[];
  if(state.settings.openaiKey){
    try{
      const sys=`You are preparing in-game "handouts" for an investigation scenario. Return JSON:
{"handouts":[{"title":string,"text":string,"imagePrompt":string}... exactly 3 items]}
The text should be short (2-5 lines) and diegetic (ledger snippets, ritual notes, map fragments). Return ONLY JSON.`;
      const res=await fetch('https://api.openai.com/v1/chat/completions',{ method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.settings.openaiKey}`},
        body: JSON.stringify({model: state.settings.openaiModel||'gpt-4o-mini', temperature:0.5, max_tokens:380, messages:[
          {role:'system',content:sys},{role:'user',content:`Scenario: ${arc.title} — ${arc.logline}. Acts: ${arc.acts.map(a=>a.name).join(' | ')}`}
        ]})
      });
      if(res.ok){ const data=await res.json(); const txt=data.choices?.[0]?.message?.content||'{}'; const out=JSON.parse(txt); handouts=out.handouts||[]; }
    }catch{ handouts=demoHandouts(); }
  }else{ handouts=demoHandouts(); }
  for(const ho of handouts){ try{ ho.imageUrl=await openaiImage(ho.imagePrompt||'aged paper note, 1920s, moody', '1024x1024'); }catch{ ho.imageUrl=await placeholderImage(ho.title||'Handout','1024x1024'); } }
  state.campaign = state.campaign || {}; state.campaign.handouts = handouts; renderHandouts();
}
function demoHandouts(){ return [
  {title:"Ledger Scrap", text:"Shipment #3417 — 'for the chapel in the ground'. Signed with a fishbone symbol.", imagePrompt:"A torn ledgersheet with ink smears, 1920s paper"},
  {title:"Sub-Basement Plan", text:"A penciled route ending in a circle labeled 'reading'.", imagePrompt:"Hand-drawn map fragment, pencil on damp paper"},
  {title:"Operator’s Card", text:"Bell once for warning, twice for welcome.", imagePrompt:"A stained index card with crisp cursive"}
]; }

/* ---------- PORTRAITS ---------- */
async function genPortraitFor(t){ const base = t.prompt || `Portrait, 1920s ${t.type==='pc'?'investigator':''} ${t.name||'character'}, moody film grain, chiaroscuro, painterly, round crop`; try{ t.portraitData=await openaiImage(base,'1024x1024'); renderTokens(); } catch{ t.portraitData=await placeholderImage(base,'512x512'); renderTokens(); } }

/* ---------- CHARACTER SHEETS ---------- */
function defaultSheet(t){
  return {
    archetype: t.type==='pc' ? 'Investigator' : 'NPC',
    persona: t.persona||'',
    hp: 10, sanity: 50, speed: t.speed||4,
    attrs:{Brains:10,Brawn:10,Nerve:10,Perception:10,Charm:10},
    skills:{Spot:60,Stealth:40,Medicine:30,Library:50,Persuade:40},
    inventory:[], conditions:[]
  };
}
let sheetTarget=null;
function openSheet(t){
  sheetTarget=t; ensureSheet(t); fillSheet(t); show('#modalSheet');
}
function ensureSheet(t){ t.sheet = t.sheet || defaultSheet(t); }
function fillSheet(t){
  byId('sheetTitle').textContent=`Character Sheet — ${t.name||'Unknown'}`;
  byId('csName').value = t.name||'';
  byId('csArch').value = t.sheet.archetype||'';
  byId('csPersona').value = t.persona || t.sheet.persona || '';
  byId('csHP').value = t.sheet.hp||0;
  byId('csSAN').value = t.sheet.sanity||0;
  byId('csSPD').value = t.sheet.speed||4;
  byId('csBrains').value = t.sheet.attrs.Brains||10;
  byId('csBrawn').value = t.sheet.attrs.Brawn||10;
  byId('csNerve').value = t.sheet.attrs.Nerve||10;
  byId('csPerc').value = t.sheet.attrs.Perception||10;
  byId('csCharm').value = t.sheet.attrs.Charm||10;
  byId('csConds').value = (t.sheet.conditions||[]).join(', ');

  // skills list
  const sk=byId('csSkills'); sk.innerHTML=''; Object.entries(t.sheet.skills||{}).forEach(([k,v])=>{
    const row=el('div',{class:'row'},[
      el('div',{class:'small'},`${k} ${v}`),
      el('button',{class:'ghost',onclick:()=>{ const r=rollPercentile(k, v); addSystemMessage(`${t.name}: ${r.text}`); }},'Roll'),
      el('button',{class:'ghost',onclick:()=>{ const nv=Number(prompt('New value', String(v))); if(!isNaN(nv)){ t.sheet.skills[k]=clamp(nv,1,99); fillSheet(t); }}},'Edit'),
      el('button',{class:'danger',onclick:()=>{ delete t.sheet.skills[k]; fillSheet(t); }},'Delete')
    ]);
    sk.appendChild(row);
  });

  // inventory list
  const inv=byId('csInv'); inv.innerHTML='';
  let totalWt=0;
  (t.sheet.inventory||[]).forEach((it,idx)=>{
    totalWt += (Number(it.weight)||0)*(Number(it.qty)||1);
    inv.appendChild(el('div',{class:'row'},[
      el('div',{class:'small'},`${it.name} ×${it.qty||1} (wt ${it.weight||0})`),
      el('button',{class:'ghost',onclick:()=>{ addLine(`${t.name} uses ${it.name}.`,'you'); if(it.qty>1){ it.qty--; } else { t.sheet.inventory.splice(idx,1); } fillSheet(t);} },'Use'),
      el('button',{class:'danger',onclick:()=>{ t.sheet.inventory.splice(idx,1); fillSheet(t);} },'Drop')
    ]));
  });
  byId('invWeight').textContent = `Weight: ${totalWt.toFixed(1)}`;
}
byId('btnAddSkill').onclick=()=>{
  if(!sheetTarget) return;
  const n=byId('csSkillName').value.trim(); const v=clamp(Number(byId('csSkillVal').value||0),1,99);
  if(!n||!v) return; sheetTarget.sheet.skills[n]=v; byId('csSkillName').value=''; byId('csSkillVal').value=''; fillSheet(sheetTarget);
};
byId('btnAddItem').onclick=()=>{
  if(!sheetTarget) return;
  const n=byId('csItemName').value.trim(); const q=clamp(Number(byId('csItemQty').value||1),1,999); const w=Math.max(0,Number(byId('csItemWt').value||0));
  if(!n) return; sheetTarget.sheet.inventory.push({name:n, qty:q, weight:w}); byId('csItemName').value=''; byId('csItemQty').value='1'; byId('csItemWt').value='0'; fillSheet(sheetTarget);
};
byId('btnSheetSave').onclick=()=>{
  if(!sheetTarget) return;
  sheetTarget.name = byId('csName').value||sheetTarget.name;
  sheetTarget.sheet.archetype = byId('csArch').value||sheetTarget.sheet.archetype;
  sheetTarget.persona = byId('csPersona').value||'';
  sheetTarget.sheet.hp = Number(byId('csHP').value)||sheetTarget.sheet.hp;
  sheetTarget.sheet.sanity = Number(byId('csSAN').value)||sheetTarget.sheet.sanity;
  sheetTarget.sheet.speed = sheetTarget.speed = Number(byId('csSPD').value)||sheetTarget.sheet.speed;
  sheetTarget.sheet.attrs = {
    Brains: Number(byId('csBrains').value)||10,
    Brawn: Number(byId('csBrawn').value)||10,
    Nerve: Number(byId('csNerve').value)||10,
    Perception: Number(byId('csPerc').value)||10,
    Charm: Number(byId('csCharm').value)||10
  };
  sheetTarget.sheet.conditions = (byId('csConds').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  renderTokens(); renderTokenList(); toast('Sheet saved');
  hide('#modalSheet');
};

/* ---------- SHOW/HIDE ---------- */
function show(sel){ const m=document.querySelector(sel); if(m) m.classList.add('show'); }
function hide(sel){ const m=document.querySelector(sel); if(m) m.classList.remove('show'); }
document.addEventListener('click',e=>{
  const t=e.target.closest('[data-close]');
  if(t) hide(t.getAttribute('data-close'));
});

/* ---------- LOCAL MEMORY SUMMARIZATION (no API) ---------- */
function maybeSummarizeLocal(){
  // After every ~12 Keeper lines, make a tiny stitched summary to shrink future prompts
  const lines = Array.from(chatLog.querySelectorAll('.line')).slice(-40);
  if(lines.length<12) return;
  const points=[];
  lines.forEach(l=>{
    const who = l.querySelector('.who')?.textContent || (l.classList.contains('you')?'You':l.classList.contains('keeper')?'Keeper':'');
    const txt = stripTags((l.querySelector('.content')?.innerHTML||l.innerHTML||'')).trim();
    if(!txt) return;
    if(points.length<10 && txt.length>6) points.push(`${who||'Narration'}: ${txt.slice(0,140)}`);
  });
  state.memory = points.slice(-8).join(' | ');
}

/* ---------- INIT ---------- */
function initialSeed(){ if(currentScene().tokens.length===0){ addToken({name:'pc0',type:'pc',x:1,y:6}); addToken({name:'pc1',type:'pc',x:2,y:6}); addToken({name:'npc0',type:'npc',x:10,y:1}); } }
function renderInitButtons(){ byId('btnInitRoll').onclick=rollAllInit; byId('btnInitNext').onclick=advanceTurn; byId('btnInitClear').onclick=clearInit; }

/* Keyboard tool binds */
document.addEventListener('keydown', e=>{ if(e.key==='v'||e.key==='V') setTool('select'); if(e.key==='r'||e.key==='R') setTool('ruler'); if(e.key==='f'||e.key==='F') setTool('reveal'); if(e.key==='h'||e.key==='H') setTool('hide'); if(e.key==='u'||e.key==='U') fogUndo(); });
function setTool(t){ tool=t; byId('tool').value=t; toast('Tool: '+t); }
byId('tool').addEventListener('change',e=> setTool(e.target.value));
byId('brush').addEventListener('change',e=> brush=Number(e.target.value));

/* Begin play banner */
function greetAndStart(){
  addSystemMessage(`<b>${escapeHtml(state.campaign?.title||'Welcome')}</b><br>${escapeHtml(state.campaign?.logline||'Learn the basics with the Keeper’s help.')}`);
  addSystemMessage(`Use <i>Start Encounter</i> for guided turns. On your turn: move up to <b>4</b> tiles, take <b>1</b> action, then type <i>/endturn</i>. For skill checks, try <i>/check Spot 60</i>.`);
}

/* Boot */
loadSettings(); initialSeed(); renderAll(); renderInitButtons(); if(!localStorage.getItem(LS_WIZARD)) startWizard(false);
</script>
</body>
</html>
